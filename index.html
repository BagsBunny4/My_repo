<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Finance Premium</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram Web Apps API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            /* --- –¶–í–ï–¢–û–í–ê–Ø –ü–ê–õ–ò–¢–†–ê --- */
            --background-color: #050608;
            --background-glow: radial-gradient(circle at 20% 20%, rgba(90, 132, 255, 0.12), transparent 35%),
                radial-gradient(circle at 80% 0%, rgba(255, 120, 80, 0.12), transparent 30%),
                #050608;
            --card-background: rgba(20, 22, 26, 0.85);
            --card-elevated: rgba(24, 26, 30, 0.9);
            --modal-background: rgba(18, 19, 22, 0.94);
            --text-primary: #F5F6F8;
            --text-secondary: #9AA0AA;
            --separator-color: rgba(255, 255, 255, 0.08);
            --row-active-bg: rgba(255, 255, 255, 0.04);

            /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
            --accent-blue: #6CA6FF;
            --accent-green: #3DD6A0;
            --accent-red: #FF6B6B;
            --accent-orange: #FFB866;
            --accent-yellow: #FFE38C;
            --accent-purple: #C9A9FF;

            /* –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–æ–Ω—ã */
            --safe-area-top: env(safe-area-inset-top, 20px);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);

            /* –¢–µ–Ω–∏ –∏ —Ä–∞–¥–∏—É—Å—ã */
            --card-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
            --card-radius: 16px;
        }

        /* --- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        html, body {
            margin: 0; padding: 0;
            background: var(--background-glow);
            color: var(--text-primary);
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            letter-spacing: 0.01em;
            height: 100vh;
            overflow: hidden;
            overflow-x: hidden; /* Added to prevent horizontal overflow */
        }

        #app-container {
            display: flex; flex-direction: column; height: 100%; width: 100%; position: relative;
        }

        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100vw; /* –§–∏–∫—Å —à–∏—Ä–∏–Ω—ã */
            -webkit-overflow-scrolling: touch;
            padding-top: calc(var(--safe-area-top) + 10px);
            padding-bottom: calc(85px + var(--safe-area-bottom));
            padding-left: 18px;
            padding-right: 18px;
            max-width: 720px;
            margin: 0 auto;
        }
        .scrollable-content::-webkit-scrollbar { display: none; }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ */
        .page-view { 
            display: none; 
            animation: fadeIn 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê --- */
        h1 { font-size: 2rem; font-weight: 700; margin: 0 0 20px 0; letter-spacing: 0.35px; }
        h2 { font-size: 0.8125rem; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; margin: 28px 0 8px 16px; letter-spacing: 0.08em; }
        
        /* –°—Ç–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .settings-header-label {
            font-size: 0.8125rem;
            font-weight: 400;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin: 24px 0 8px 16px;
            letter-spacing: -0.1px;
        }

        /* --- –ö–ê–†–¢–û–ß–ö–ò --- */
        .card-container {
            background: var(--card-background);
            border-radius: var(--card-radius);
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .target-debt-card {
            border: 1px solid rgba(255, 184, 102, 0.4);
            box-shadow: 0 16px 40px rgba(255, 184, 102, 0.18);
            background: linear-gradient(135deg, rgba(255, 184, 102, 0.12), rgba(255, 135, 80, 0.08))
                , var(--card-background);
        }

        .list-item-row {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Changed from space-between */
            flex-wrap: wrap; /* Added for adaptability */
            padding: 14px 18px;
            min-height: 56px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent 80%), var(--card-background);
            position: relative;
            transition: background 0.2s ease, transform 0.15s ease;
        }
        
        .list-item-row.is-focused { background-color: var(--row-active-bg); }
        .list-item-row:active { background-color: var(--row-active-bg); transform: translateY(1px); }
        .list-item-row:not(:last-child)::after {
            content: ''; position: absolute; bottom: 0; left: 16px; right: 0; height: 0.5px; background-color: var(--separator-color);
        }

        .row-label { 
            font-size: 1.0625rem; color: var(--text-primary); flex-shrink: 0; 
            white-space: nowrap; margin-right: 12px; max-width: 50%; overflow: hidden; text-overflow: ellipsis;
        }
        
        .row-input {
            flex: 1 1 auto; /* Changed for better flex */
            background: transparent; 
            border: none; 
            color: var(--accent-blue);
            font-size: 1.0625rem; 
            text-align: right; 
            padding: 0; 
            margin: 0;
            border-radius: 0; 
            caret-color: var(--accent-blue); 
            font-variant-numeric: tabular-nums;
            
            /* FIX: Adaptive input width */
            max-width: 100%;
            min-width: 0;
            width: auto; /* Added */

            /* FIX FOR INPUT CLICKING */
            position: relative;
            z-index: 10;
            -webkit-user-select: text;
            user-select: text;
        }
        .row-input::placeholder { color: var(--text-secondary); opacity: 0.6; }
        .row-input:focus::placeholder { opacity: 0; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
        .input-large-block {
            width: 100%;
            background: transparent;
            border: none;
            color: #FFF;
            font-size: 1.125rem;
            padding: 12px 0;
            border-bottom: 0.5px solid var(--separator-color);
            margin-bottom: 16px;
            border-radius: 0;
        }
        .input-large-block::placeholder { color: var(--text-secondary); opacity: 0.5; }
        
        input[type="date"] { color-scheme: dark; font-family: inherit; }

        .row-select-indicator {
            flex: 1; display: flex; justify-content: flex-end; align-items: center;
            cursor: pointer; color: var(--text-secondary); font-size: 1.0625rem;
        }
        .chevron-icon { opacity: 0.3; margin-left: 8px; font-size: 18px; font-weight: 600; font-family: system-ui; }

        /* --- –í–ò–î–ñ–ï–¢–´ --- */
        .date-navigator {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(118, 118, 128, 0.12); border-radius: 10px; padding: 4px; margin-bottom: 20px; width: 100%;
        }
        .date-nav-button {
            width: 44px; height: 32px; display: flex; align-items: center; justify-content: center;
            color: var(--accent-blue); cursor: pointer; border-radius: 8px;
        }
        .date-nav-button:active { background: rgba(255, 255, 255, 0.1); }
        .date-nav-label { font-size: 0.9375rem; font-weight: 600; color: var(--text-primary); text-transform: capitalize; }

        .balance-display-card {
            background: linear-gradient(135deg, rgba(108, 166, 255, 0.12), rgba(201, 169, 255, 0.08)), var(--card-elevated);
            border-radius: var(--card-radius); padding: 24px; text-align: center; margin-bottom: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* FIX: Adaptive balance font size */
        .balance-amount { 
            font-size: clamp(28px, 8vw, 40px); 
            font-weight: 700; 
            letter-spacing: 0.5px; 
            color: #FFFFFF; 
            font-family: "SF Pro Display", sans-serif; 
            word-break: break-all;
        }

        .statistics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .stat-item-box { background: var(--card-background); border-radius: 12px; padding: 16px; display: flex; flex-direction: column; justify-content: center; }
        .stat-item-label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; }
        
        /* FIX: Adaptive grid font size */
        .stat-item-value { 
            font-size: clamp(14px, 5vw, 18px); 
            font-weight: 600; 
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .text-green { color: var(--accent-green); } .text-red { color: var(--accent-red); }

        .segment-control-container {
            background: rgba(255, 255, 255, 0.04); padding: 2px; border-radius: 12px;
            display: flex; margin: 0 auto 24px; width: 100%; max-width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .segment-button {
            flex: 1; text-align: center; padding: 9px; font-size: 0.875rem; font-weight: 600;
            border-radius: 9px; cursor: pointer; color: var(--text-primary); transition: all 0.2s;
        }
        .segment-button.active { background: rgba(255, 255, 255, 0.08); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05); }

        /* --- –ì–†–ê–§–ò–ö–ò --- */
        .chart-container-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .donut-chart-circle {
            width: min(210px, 50vw); height: min(210px, 50vw); border-radius: 50%;
            background: conic-gradient(var(--card-background) 0% 100%);
            display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
        }
        .donut-chart-inner {
            width: 170px; height: 170px; background: var(--background-color); border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .category-color-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
        .percentage-badge { font-size: 14px; color: var(--text-secondary); min-width: 40px; text-align: right; }
        
        .progress-track { background: rgba(255, 255, 255, 0.1); border-radius: 4px; height: 6px; width: 100%; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .limit-info { font-size: 11px; color: var(--text-secondary); margin-top: 5px; display: flex; justify-content: space-between; }
        .interactive-row { cursor: pointer; transition: transform 0.1s, background-color 0.2s; }
        .interactive-row:active { transform: scale(0.98); background-color: rgba(255, 255, 255, 0.05) !important; }

        /* --- –ò–°–¢–û–†–ò–Ø --- */
        .history-list-item { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 4px 0; }
        .history-item-left { display: flex; flex-direction: column; overflow: hidden; }
        .history-item-category { font-size: 17px; font-weight: 500; margin-bottom: 3px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item-meta { font-size: 13px; color: var(--text-secondary); }
        .history-item-right { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .history-item-amount { font-size: 17px; font-weight: 600; font-variant-numeric: tabular-nums; }
        .action-icon-button { font-size: 20px; padding: 8px; cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; }

        /* --- –ú–ï–ù–Æ (NAVBAR) --- */
        .bottom-navbar {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            height: calc(55px + var(--safe-area-bottom));
            background: rgba(20, 20, 20, 0.85); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(255, 255, 255, 0.15); 
            display: flex; align-items: flex-start; padding-top: 8px; z-index: 1000;
        }
        .navbar-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: #8E8E93; cursor: pointer; transition: color 0.2s; }
        .navbar-item.active { color: var(--accent-blue); }
        .navbar-item svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .navbar-item span { font-size: 10px; font-weight: 500; }

        .button-primary {
            width: 100%; background: linear-gradient(135deg, rgba(108, 166, 255, 0.95), rgba(201, 169, 255, 0.85)); color: white; border: none;
            padding: 16px; border-radius: 14px; font-size: 17px; font-weight: 700; margin-top: 12px; cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease;
            box-shadow: 0 10px 24px rgba(108, 166, 255, 0.35);
        }
        .button-primary:active { transform: translateY(1px); box-shadow: 0 6px 16px rgba(108, 166, 255, 0.25); }
        .hidden { display: none !important; }

        /* --- –ú–û–î–ê–õ–ö–ê (POPUP) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 20%, rgba(108,166,255,0.14), transparent 32%),
                        radial-gradient(circle at 80% 0%, rgba(255,184,102,0.12), transparent 28%),
                        rgba(0, 0, 0, 0.65);
            z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            display: flex; flex-direction: column; justify-content: flex-end; backdrop-filter: blur(10px);
        }
        .modal-overlay.visible { opacity: 1; pointer-events: all; }

        /* –®—Ç–æ—Ä–∫–∞ */
        .modal-content-sheet {
            background: linear-gradient(145deg, rgba(24, 26, 30, 0.96), rgba(16, 17, 20, 0.96));
            border-radius: 24px 24px 0 0;
            padding-bottom: calc(30px + var(--safe-area-bottom));
            width: 100%; max-height: 85%; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 -12px 40px rgba(0,0,0,0.55); border: 1px solid rgba(255,255,255,0.06);
        }
        .modal-overlay.visible .modal-content-sheet { transform: translateY(0); }

        .modal-topbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 18px 10px 18px; position: sticky; top: 0; backdrop-filter: blur(8px);
            background: linear-gradient(180deg, rgba(255,255,255,0.04), transparent);
        }
        .modal-handle { width: 48px; height: 5px; border-radius: 999px; background: rgba(255,255,255,0.18); margin: 0 auto 12px auto; }
        .modal-heading { font-size: 1.05rem; margin: 0; color: #fff; letter-spacing: 0.2px; }
        .modal-subheading { font-size: 0.9rem; color: var(--text-secondary); margin: 6px 0 0 0; }
        .modal-close { color: var(--text-secondary); font-weight: 600; cursor: pointer; padding: 8px 10px; border-radius: 10px; transition: background 0.2s ease; }
        .modal-close:hover { background: rgba(255,255,255,0.06); }
        .modal-body { padding: 0 18px 18px 18px; display: flex; flex-direction: column; gap: 14px; }
        .modal-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 18px; padding: 14px 16px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
        }
        .modal-input-wrap {
            display: flex; align-items: center; gap: 10px; padding: 14px 16px; border-radius: 14px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.06);
        }
        .modal-input { width: 100%; background: transparent; border: none; color: #fff; font-size: 20px; text-align: center; }
        .modal-label { font-size: 0.93rem; color: var(--text-secondary); margin-bottom: 6px; display: block; }
        .modal-actions { display: flex; gap: 10px; }
        .ghost-button { flex: 1; background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .ghost-button:hover { background: rgba(255,255,255,0.08); }
        .ghost-button.primary { background: linear-gradient(135deg, rgba(108,166,255,0.95), rgba(201,169,255,0.9)); border: none; box-shadow: 0 10px 20px rgba(108,166,255,0.3); color: #fff; }

        .modal-header { padding: 16px 18px; font-weight: 600; border-bottom: 0.5px solid var(--separator-color); color: var(--text-secondary); text-align: left; }
        .modal-scroll-area { overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ */
        .modal-centered {
            background: linear-gradient(160deg, rgba(24,26,30,0.96), rgba(12,13,16,0.98)); border-radius: 20px;
            width: min(85%, 420px); margin: auto; border: 1px solid rgba(255,255,255,0.06);
            overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 60px rgba(0,0,0,0.55);
        }
        .modal-centered .modal-body { padding: 0 24px 22px 24px; }
        .modal-centered h3 { font-size: 20px; letter-spacing: 0.2px; }
        .modal-divider { height: 1px; background: rgba(255,255,255,0.06); margin: 0 24px; }

        .premium-slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 12px; border-radius: 999px;
            background: linear-gradient(90deg, rgba(108,166,255,0.55), rgba(201,169,255,0.45));
            outline: none; box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
        }
        .premium-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 26px; height: 26px; border-radius: 50%;
            background: linear-gradient(135deg, #7FB3FF, #C9A9FF);
            box-shadow: 0 10px 25px rgba(108,166,255,0.35), inset 0 1px 0 rgba(255,255,255,0.5);
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer;
        }
        .premium-slider::-moz-range-thumb {
            width: 26px; height: 26px; border-radius: 50%;
            background: linear-gradient(135deg, #7FB3FF, #C9A9FF);
            box-shadow: 0 10px 25px rgba(108,166,255,0.35), inset 0 1px 0 rgba(255,255,255,0.5);
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer;
        }

        .avatar-circle { background: #636366; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; color: #FFF; font-size: 14px; flex-shrink: 0; }
        .owner-badge { color: var(--accent-yellow); font-size: 11px; border: 1px solid var(--accent-yellow); padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
        .me-badge { color: var(--text-secondary); font-size: 13px; margin-left: 5px; }

        .load-more-btn {
            width: 100%; padding: 12px; text-align: center; color: var(--accent-blue);
            font-size: 15px; font-weight: 500; margin-top: 10px; cursor: pointer;
            background: rgba(118, 118, 128, 0.12); border-radius: 8px;
        }
        .load-more-btn:active { background: rgba(118, 118, 128, 0.2); }

        /* SETTINGS */
        .settings-section { margin-bottom: 20px; }
        .settings-card { background: var(--card-background); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); box-shadow: var(--card-shadow); overflow: hidden; }
        .settings-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; gap: 12px; }
        .settings-row + .settings-row { border-top: 1px solid var(--separator-color); }
        .settings-label-block { display: flex; align-items: center; gap: 12px; }
        .settings-icon { width: 38px; height: 38px; border-radius: 12px; display: grid; place-items: center; color: #fff; font-size: 18px; }
        .settings-title { font-size: 1rem; font-weight: 600; color: #fff; }
        .settings-hint { font-size: 13px; color: var(--text-secondary); }
        .settings-arrow { color: var(--text-secondary); font-size: 18px; }
        .settings-note { font-size: 13px; color: var(--text-secondary); line-height: 1.5; padding: 0 4px 8px 4px; }

        /* DEBT UI */
        .pain-badge { background: rgba(255, 69, 58, 0.15); color: #FF453A; padding: 6px 10px; border-radius: 6px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; margin-top: 5px; }
        .target-badge { background: rgba(255, 159, 10, 0.2); color: var(--accent-orange); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid rgba(255, 159, 10, 0.5); margin-left: 8px; }
        .debt-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .debt-amount-large { font-size: 22px; font-weight: 700; color: #FFF; font-variant-numeric: tabular-nums; }
        .debt-actions { display: flex; gap: 10px; margin-top: 12px; }
        .btn-small { flex: 1; padding: 10px; font-size: 14px; font-weight: 600; border-radius: 8px; text-align: center; cursor: pointer; }
        .btn-pay { background: var(--accent-blue); color: #FFF; }
        .btn-more { background: rgba(118, 118, 128, 0.2); color: var(--text-secondary); }
        .strategy-info-box { background: linear-gradient(135deg, #1C1C1E 0%, #2A2A2D 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;}

        /* --- IMPULSE BUY BUTTON & MODAL --- */
        .impulse-btn-large {
            width: 100%; margin: 20px 0; padding: 16px;
            background: linear-gradient(135deg, #BF5AF2 0%, #AF52DE 100%);
            border-radius: 12px; text-align: center; color: white;...(truncated 78388 characters)...         if (currentChartMode !== 'expense') return; 
            currentBudgetCategoryId = id; document.getElementById('budget-modal-title').innerText = name; document.getElementById('input-budget-limit').value = currentLimit > 0 ? currentLimit : '';
            const statsContainer = document.getElementById('budget-stats-container'); statsContainer.innerHTML = '<div style="text-align: center; color: #8E8E93; font-size: 13px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞...</div>';
            document.getElementById('budget-modal-overlay').classList.add('visible'); document.getElementById('input-budget-limit').focus(); loadBudgetStats(name);
        }

        async function loadBudgetStats(categoryName) {
            const container = document.getElementById('budget-stats-container');
            try {
                const data = await callApi('get_category_stats', { category: categoryName });
                if (!data.history || data.history.length === 0) { container.innerHTML = '<div style="text-align: center; color: #8E8E93; font-size: 13px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; return; }
                let html = ''; data.history.forEach(h => { html += `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;"><span style="color:#8E8E93">${h.label}</span><span>${currencyFormatter(h.amount)}</span></div>`; }); container.innerHTML = html;
            } catch (e) { container.innerHTML = 'Error'; }
        }

        function closeBudgetModal() { document.getElementById('budget-modal-overlay').classList.remove('visible'); currentBudgetCategoryId = null; }
        async function saveBudgetFromModal() {
            const val = parseFloat(document.getElementById('input-budget-limit').value); const categoryName = document.getElementById('budget-modal-title').innerText;
            if (isNaN(val) || val < 0) return;
            closeBudgetModal(); TelegramWebApp.MainButton.showProgress();
            try { await callApi('set_budget', { category_name: categoryName, limit: val }); refreshHomePage(); TelegramWebApp.HapticFeedback.notificationOccurred('success'); } catch (e) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞"); }
            TelegramWebApp.MainButton.hideProgress();
        }

        function openEditMode(t) {
            if (!t.id) return; editingTransactionId = t.id;
            document.getElementById('input-transaction-amount').value = Math.abs(t.amount); document.getElementById('input-transaction-comment').value = t.comment;
            try { const parts = t.date.split(' ')[0].split('.'); document.getElementById('input-transaction-date').value = `${parts[2]}-${parts[1]}-${parts[0]}`; } catch(e) { }
            const cat = categoriesList.find(c => c.name === t.category);
            if (cat) { selectedCategoryId = cat.id; document.getElementById('display-selected-category').innerText = cat.name; document.getElementById('display-selected-category').style.color = '#FFFFFF'; }
            document.getElementById('add-page-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"; document.getElementById('edit-mode-indicator').classList.remove('hidden'); document.getElementById('button-cancel-edit').classList.remove('hidden'); navigateToPage('page-add');
        }

        function cancelEditMode() {
            editingTransactionId = null; document.getElementById('input-transaction-amount').value = ''; document.getElementById('input-transaction-comment').value = ''; document.getElementById('display-selected-category').innerText = '–í—ã–±—Ä–∞—Ç—å'; document.getElementById('display-selected-category').style.color = '#8E8E93'; selectedCategoryId = null;
            document.getElementById('add-page-title').innerText = "–ó–∞–ø–∏—Å—å"; document.getElementById('edit-mode-indicator').classList.add('hidden'); document.getElementById('button-cancel-edit').classList.add('hidden');
        }

        async function deleteTransaction(id) { TelegramWebApp.showConfirm("–£–¥–∞–ª–∏—Ç—å?", async (ok) => { if (ok) { await callApi('delete_transaction', { id: id }); refreshHomePage(); } }); }

        function setNewCategoryType(type, el) { el.parentElement.querySelectorAll('.segment-button').forEach(btn => btn.classList.remove('active')); el.classList.add('active'); newCategoryTypeMode = type; }
        
        async function loadCategoriesFromBackend() { categoriesList = await callApi('get_categories'); }

        async function renderSettingsPage() {
            loadFamilyMembers(); 
            
            // Load Settings for Emergency Fund
            try {
                const settings = await callApi('get_settings');
                if(settings.emergency_fund_goal) {
                    document.getElementById('input-settings-emergency').value = settings.emergency_fund_goal;
                }
            } catch(e) {}

            const list = document.getElementById('settings-categories-list'); list.innerHTML = '';
            if (!categoriesList.length) { list.innerHTML = '–ü—É—Å—Ç–æ'; return; }
            [...categoriesList].sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const color = c.type === 'expense' ? '#FF453A' : '#30D158';
                const row = document.createElement('div'); row.className = 'list-item-row';
                row.innerHTML = `<div style="display:flex;align-items:center;"><div class="category-color-dot" style="background:${color}"></div><span style="font-size:17px">${c.name}</span></div><div style="display:flex; align-items:center;"><div class="action-icon-button" onclick="editCategory('${c.id}', '${c.name}')" style="color:#0A84FF; font-size:20px; margin-right:10px;">‚úé</div><div class="action-icon-button" onclick="deleteCategory('${c.id}')" style="color:#FF453A; font-size:22px;">√ó</div></div>`;
                list.appendChild(row);
            });
        }
        
        async function editCategory(id, currentName) {
            const newName = prompt("–ù–æ–≤–æ–µ –∏–º—è:", currentName);
            if (newName && newName !== currentName) {
                TelegramWebApp.MainButton.showProgress();
                try { await callApi('edit_category', { id: id, new_name: newName.trim() }); categoriesList.find(c => c.id === id).name = newName.trim(); renderSettingsPage(); TelegramWebApp.HapticFeedback.notificationOccurred('success'); } catch (e) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞: " + e.message); }
                TelegramWebApp.MainButton.hideProgress();
            }
        }

        async function loadFamilyMembers() { try { const data = await callApi('get_family_members'); renderFamilyList(data); } catch (e) {} }
        function renderFamilyList(data) {
            const list = document.getElementById('family-list-container'); const title = document.getElementById('family-list-title');
            if (!data.members || data.members.length < 1) { list.classList.add('hidden'); title.classList.add('hidden'); return; }
            list.classList.remove('hidden'); title.classList.remove('hidden'); list.innerHTML = '';
            data.members.forEach(m => {
                const isMe = (m.id == myTelegramId); let badges = ''; if (m.is_owner) badges += '<span class="owner-badge">–í–ª–∞–¥–µ–ª–µ—Ü</span>'; if (isMe) badges += '<span class="me-badge">(–í—ã)</span>';
                let deleteBtn = ''; if (data.is_requester_owner && !isMe) deleteBtn = `<div class="action-icon-button" onclick="kickMember('${m.id}', '${m.name}')" style="color:#FF453A; padding-left:15px;">‚úï</div>`;
                const row = document.createElement('div'); row.className = 'list-item-row';
                row.innerHTML = `<div style="display:flex; align-items:center; overflow:hidden;"><div class="avatar-circle">${m.name.charAt(0).toUpperCase()}</div><div style="display:flex; flex-direction:column;"><span style="font-size:17px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.name}</span></div>${badges}</div>${deleteBtn}`;
                list.appendChild(row);
            });
        }
        function kickMember(id, name) { TelegramWebApp.showConfirm(`–ò—Å–∫–ª—é—á–∏—Ç—å ${name}?`, async (ok) => { if (ok) { try { await callApi('kick_member', { id: id }); loadFamilyMembers(); } catch (e) {} } }); }

        document.getElementById('button-create-category').onclick = async () => {
            const name = document.getElementById('input-new-category-name').value.trim();
            if (!name) return TelegramWebApp.showAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏");
            await callApi('add_category', { name: name, type: newCategoryTypeMode });
            document.getElementById('input-new-category-name').value = ''; await loadCategoriesFromBackend(); renderSettingsPage(); TelegramWebApp.HapticFeedback.notificationOccurred('success');
        };

        async function deleteCategory(id) { TelegramWebApp.showConfirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?", async (ok) => { if (ok) { await callApi('delete_category', { id: id }); categoriesList = categoriesList.filter(c => c.id !== id); renderSettingsPage(); } }); }

        function inviteFamilyMember() {
            if (!myTelegramId) return TelegramWebApp.showAlert("–û—à–∏–±–∫–∞ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
            const inviteUrl = `https://t.me/share/url?url=https://t.me/${BOT_USERNAME}?start=join_${myTelegramId}&text=–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –º–æ–µ–º—É —Å–µ–º–µ–π–Ω–æ–º—É –±—é–¥–∂–µ—Ç—É!`;
            TelegramWebApp.openTelegramLink(inviteUrl);
        }

        // --- GLOBAL MODAL CONTROLLER ---
        const modalOverlay = document.getElementById('modal-overlay');
        const modalList = document.getElementById('modal-list-container');
        const modalTitle = document.getElementById('modal-header-title');
        
        function openCategorySelectionModal() {
            modalTitle.innerText = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è"; modalList.innerHTML = '';
            let typeToFilter = transactionType;
            if (document.getElementById('page-add-subscription').classList.contains('active')) { typeToFilter = 'expense'; }
            const filteredCats = categoriesList.filter(c => c.type === typeToFilter);
            if (filteredCats.length === 0) { modalList.innerHTML = '<div style="padding:20px;text-align:center;color:#8E8E93">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π —ç—Ç–æ–≥–æ —Ç–∏–ø–∞</div>'; }
            [...filteredCats].sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const color = c.type === 'expense' ? '#FF453A' : '#30D158'; const row = document.createElement('div'); row.className = 'list-item-row'; row.style.cursor = 'pointer';
                const isSubMode = document.getElementById('page-add-subscription').classList.contains('active');
                row.onclick = () => { 
                    selectedCategoryId = c.id; 
                    if (isSubMode) { document.getElementById('display-selected-category-sub').innerText = c.name; document.getElementById('display-selected-category-sub').style.color = '#FFFFFF'; } 
                    else { document.getElementById('display-selected-category').innerText = c.name; document.getElementById('display-selected-category').style.color = '#FFFFFF'; }
                    modalOverlay.classList.remove('visible'); 
                };
                row.innerHTML = `<div style="display:flex;align-items:center;"><div class="category-color-dot" style="background:${color}"></div><span style="font-size:17px">${c.name}</span></div>${selectedCategoryId === c.id ? '<span style="color:#0A84FF">‚úì</span>' : ''}`;
                modalList.appendChild(row);
            });
            modalOverlay.classList.add('visible');
        }

        function openWalletSelectionModal(mode) {
            walletSelectionMode = mode; modalTitle.innerText = mode === 'from' ? "–°—á–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è" : "–ö—É–¥–∞ –∑–∞—á–∏—Å–ª–∏—Ç—å"; modalList.innerHTML = '';
            if (walletsList.length === 0) { callApi('get_wallets').then(d => { walletsList = d.wallets; renderWalletModalItems(); }); } else { renderWalletModalItems(); }
            modalOverlay.classList.add('visible');
        }

        function renderWalletModalItems() {
            modalList.innerHTML = '';
            walletsList.forEach(w => {
                const row = document.createElement('div'); row.className = 'list-item-row'; row.style.cursor = 'pointer';
                row.onclick = () => { 
                    if (walletSelectionMode === 'from') { selectedWalletId = w.uuid; const display = document.getElementById('display-selected-wallet'); display.innerText = "üí≥ " + w.name; display.style.color = '#FFFFFF'; } 
                    else { selectedWalletToId = w.uuid; const display = document.getElementById('display-wallet-to'); display.innerText = "üí≥ " + w.name; display.style.color = '#FFFFFF'; }
                    modalOverlay.classList.remove('visible'); 
                };
                row.innerHTML = `<div style="display:flex; flex-direction:column;"><span style="font-size:17px; font-weight:500;">${w.name} ${w.is_default?'<span style="color:var(--accent-yellow)">‚òÖ</span>':''}</span></div><span style="color:#888; font-size:15px;">${currencyFormatter(w.balance)}</span>`;
                modalList.appendChild(row);
            });
        }

        modalOverlay.onclick = (e) => { if (e.target === modalOverlay) modalOverlay.classList.remove('visible'); }

        TelegramWebApp.MainButton.onClick(async () => {
            const amt = document.getElementById('input-transaction-amount').value; const cmt = document.getElementById('input-transaction-comment').value; const dateVal = document.getElementById('input-transaction-date').value; 
            if (!amt) return TelegramWebApp.showAlert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"); if (!dateVal) return TelegramWebApp.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É");
            TelegramWebApp.MainButton.showProgress();
            try {
                if (transactionType === 'transfer') {
                    if (!selectedWalletId || !selectedWalletToId) { TelegramWebApp.MainButton.hideProgress(); return TelegramWebApp.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–∞ —Å—á–µ—Ç–∞"); }
                    if (selectedWalletId === selectedWalletToId) { TelegramWebApp.MainButton.hideProgress(); return TelegramWebApp.showAlert("–°—á–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏"); }
                    await callApi('transfer_between_wallets', { from_wallet: selectedWalletId, to_wallet: selectedWalletToId, amount: amt, date: dateVal, comment: cmt });
                    TelegramWebApp.HapticFeedback.notificationOccurred('success'); document.getElementById('input-transaction-amount').value = ''; document.getElementById('input-transaction-comment').value = ''; navigateToPage('page-home');
                } else {
                    const cat = categoriesList.find(c => c.id === selectedCategoryId);
                    if (!cat) { TelegramWebApp.MainButton.hideProgress(); return TelegramWebApp.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"); }
                    if (editingTransactionId) { await callApi('edit_transaction', { id: editingTransactionId, amount: amt, category: cat.name, type: transactionType, comment: cmt, date: dateVal, wallet_uuid: selectedWalletId }); TelegramWebApp.HapticFeedback.notificationOccurred('success'); cancelEditMode(); navigateToPage('page-home'); } 
                    else { await callApi('add_transaction', { amount: amt, category: cat.name, type: transactionType, comment: cmt, date: dateVal, wallet_uuid: selectedWalletId }); TelegramWebApp.HapticFeedback.notificationOccurred('success'); document.getElementById('input-transaction-amount').value = ''; document.getElementById('input-transaction-comment').value = ''; navigateToPage('page-home'); }
                }
            } catch (error) { console.error(error); }
            TelegramWebApp.MainButton.hideProgress();
        });

        async function startApp() {
            TelegramWebApp.ready(); TelegramWebApp.expand(); TelegramWebApp.setHeaderColor('#000000'); TelegramWebApp.setBackgroundColor('#000000');
            try {
                const check = await callApi('check_user'); document.getElementById('loading-screen').classList.add('hidden');
                if (check.is_registered) { myTelegramId = check.user_id; document.getElementById('app-container').classList.remove('hidden'); categoriesList = await callApi('get_categories'); const wData = await callApi('get_wallets'); walletsList = wData.wallets; refreshHomePage(); } 
                else { document.getElementById('authorization-screen').classList.remove('hidden'); }
            } catch (error) { console.error("Init:", error); }
        }
        startApp();
    </script>
</body>
</html>

        /* Media Queries for Responsiveness */
        @media (min-width: 600px) {
            .scrollable-content { padding-left: 32px; padding-right: 32px; max-width: 600px; margin: 0 auto; }
            .statistics-grid { grid-template-columns: repeat(4, 1fr); }
            h1 { font-size: 2.5rem; }
            h2 { font-size: 1rem; }
            .row-label { font-size: 1.25rem; }
            .row-input { font-size: 1.25rem; }
            .input-large-block { font-size: 1.25rem; }
        }

        @media (max-width: 320px) {
            .row-label { max-width: 40%; font-size: 15px; }
            .row-input { font-size: 15px; }
            .balance-amount { font-size: clamp(24px, 8vw, 32px); }
            .stat-item-label { font-size: 11px; }
            .stat-item-value { font-size: clamp(12px, 5vw, 16px); }
        }
    </style>
</head>
<body>

    <!-- –ó–ê–ì–†–£–ó–ö–ê -->
    <div id="loading-screen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;display:flex;align-items:center;justify-content:center;">
        <div style="color:#8E8E93; font-size: 16px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –≠–ö–†–ê–ù –¢–†–ï–ë–û–í–ê–ù–ò–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
    <div id="authorization-screen" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:5000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px;text-align:center;">
        <h1 id="auth-screen-title">–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã</h1>
        <p id="auth-screen-desc" style="color:#8E8E93;margin-bottom:30px;line-height:1.5;font-size:16px;">
            –í—ã –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª–∏ Google –¢–∞–±–ª–∏—Ü—É.<br><br>
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
        </p>
        <button onclick="Telegram.WebApp.close()" class="button-primary" style="width:auto;padding:12px 40px;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- IMPULSE BUY MODAL -->
    <div id="impulse-modal" class="modal-overlay">
        <div class="modal-content-sheet">
            <div class="modal-handle"></div>
            <div class="modal-topbar">
                <div>
                    <h2 class="modal-heading">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–µ–ª–∞–Ω–∏—è üõç</h2>
                    <p class="modal-subheading">–ë—ã—Å—Ç—Ä–æ –æ—Ü–µ–Ω–∏–º —Ü–µ–Ω—É –∏–º–ø—É–ª—å—Å–∞</p>
                </div>
                <div class="modal-close" onclick="closeImpulseModal()">–ó–∞–∫—Ä—ã—Ç—å</div>
            </div>

            <div class="modal-body">
                <label class="modal-label">–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –≤–µ—â—å?</label>
                <div class="modal-input-wrap">
                    <input type="number" id="input-impulse-amount" class="modal-input" placeholder="0" oninput="checkImpulse(this.value)">
                    <span style="color: var(--text-secondary); font-size: 18px;">‚ÇΩ</span>
                </div>

                <div id="impulse-loading" class="hidden" style="text-align:center; color:var(--text-secondary);">–°—á–∏—Ç–∞—é –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è...</div>

                <div id="impulse-results" class="hidden" style="display:flex; flex-direction:column; gap:12px;">
                    <div class="modal-card">
                        <div class="impulse-stat-row">
                            <span style="color:var(--text-secondary)">–≠—Ç–æ –æ—Ç –æ–±—â–µ–≥–æ –¥–æ–ª–≥–∞:</span>
                            <span id="impulse-res-percent" class="impulse-stat-val">0%</span>
                        </div>
                        <div class="impulse-stat-row">
                            <span style="color:var(--text-secondary)">–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏ (%):</span>
                            <span id="impulse-res-lost" class="impulse-stat-val" style="color:#FF6B6B">0 ‚ÇΩ</span>
                        </div>
                        <div class="impulse-warning" id="impulse-res-text">
                            –≠—Ç–∞ –ø–æ–∫—É–ø–∫–∞ –æ—Ç–æ–¥–≤–∏–Ω–µ—Ç –≤–∞—à—É —Å–≤–æ–±–æ–¥—É –Ω–∞ 5 –¥–Ω–µ–π.
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="ghost-button" onclick="proceedToBuy()">–í—Å—ë —Ä–∞–≤–Ω–æ –∫—É–ø–∏—Ç—å</button>
                        <button class="ghost-button primary" onclick="proceedToRepay()">–ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIMULATOR MODAL -->
    <div id="sim-modal" class="modal-overlay">
        <div class="modal-content-sheet">
            <div class="modal-handle"></div>
            <div class="modal-topbar">
                <div>
                    <h2 class="modal-heading">–£—Å–∫–æ—Ä–∏—Ç–µ–ª—å üöÄ</h2>
                    <p class="modal-subheading">–°–∫–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏–º –∫ –ø–ª–∞—Ç–µ–∂—É?</p>
                </div>
                <div class="modal-close" onclick="closeSim()">–ì–æ—Ç–æ–≤–æ</div>
            </div>
            <div class="modal-body">
                <div class="modal-card" style="text-align:center; gap:8px; display:flex; flex-direction:column; align-items:center;">
                    <div class="modal-label" style="margin:0;">–ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –Ω–∞–¥–±–∞–≤–∫–∞</div>
                    <div id="sim-display-amount" class="sim-value-large">+ 0 ‚ÇΩ</div>
                    <input type="range" id="sim-slider" min="0" max="50000" step="1000" value="0" oninput="updateSimulator(this.value)" class="premium-slider">
                </div>
                <div class="modal-card" style="display:flex; justify-content:space-between; align-items:center; gap:16px;">
                    <div>
                        <div class="sim-label">–ù–æ–≤–∞—è –¥–∞—Ç–∞ —Å–≤–æ–±–æ–¥—ã</div>
                        <div id="sim-res-date" class="sim-data">...</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="sim-label">–í—ã–≥–æ–¥–∞</div>
                        <div id="sim-res-saved" class="sim-data sim-better">0 ‚ÇΩ</div>
                    </div>
                </div>
                <div style="font-size:12px; color:var(--text-secondary); text-align:center; line-height:1.5;">–ü–µ—Ä–µ–¥–≤–∏–≥–∞—è –ø–æ–ª–∑—É–Ω–æ–∫, –≤—ã –≤–∏–¥–∏—Ç–µ, –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è —Å–æ–∫—Ä–∞—â–∞—é—Ç —Å—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞.</div>
            </div>
        </div>
    </div>

    <!-- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div id="app-container" class="hidden">
        <div class="scrollable-content">
            
            <!-- HOME PAGE -->
            <div id="page-home" class="page-view active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h1 style="margin:0">–°–≤–æ–¥–∫–∞</h1>
                </div>
                
                <div class="date-navigator">
                    <div class="date-nav-button" onclick="changeMonth(-1)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></div>
                    <div id="current-date-display" class="date-nav-label">...</div>
                    <div class="date-nav-button" onclick="changeMonth(1)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></div>
                </div>
                
                <div class="balance-display-card">
                    <div class="balance-title">–°–∞–ª—å–¥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                    <div id="display-balance-value" class="balance-amount">0 ‚ÇΩ</div>
                </div>

                <div class="statistics-grid">
                    <div class="stat-item-box">
                        <div class="stat-item-label">–î–æ—Ö–æ–¥—ã</div>
                        <div id="display-income-value" class="stat-item-value text-green">0</div>
                    </div>
                    <div class="stat-item-box">
                        <div class="stat-item-label">–†–∞—Å—Ö–æ–¥—ã</div>
                        <div id="display-expense-value" class="stat-item-value text-red">0</div>
                    </div>
                    <div class="stat-item-box">
                        <div class="stat-item-label">–¢—Ä–∞—Ç—ã –≤ –¥–µ–Ω—å</div>
                        <div id="display-daily-value" class="stat-item-value">0</div>
                    </div>
                    <div class="stat-item-box">
                        <div class="stat-item-label">–ü—Ä–æ–≥–Ω–æ–∑ —Ç—Ä–∞—Ç</div>
                        <div id="display-forecast-value" class="stat-item-value" style="color: var(--accent-orange);">0</div>
                    </div>
                </div>

                <!-- IMPULSE BUTTON -->
                <div class="impulse-btn-large" onclick="openImpulseModal()">
                    üõç –•–æ—á—É –∫—É–ø–∏—Ç—å...
                </div>

                <div class="segment-control-container">
                    <div class="segment-button active" onclick="setChartMode('expense', this)">–†–∞—Å—Ö–æ–¥—ã</div>
                    <div class="segment-button" onclick="setChartMode('income', this)">–î–æ—Ö–æ–¥—ã</div>
                </div>

                <div id="chart-container-wrapper" class="chart-container-wrapper">
                    <div class="donut-chart-circle" id="donut-chart">
                        <div class="donut-chart-inner">
                            <div style="font-size:11px; color:#8E8E93; text-transform:uppercase; margin-bottom:4px;">–ò—Ç–æ–≥–æ</div>
                            <div id="display-chart-total" style="font-size:22px; font-weight:600;">0</div>
                        </div>
                    </div>
                    <div class="card-container" id="chart-legend-list" style="width:100%"></div>
                </div>
                
                <div id="state-empty-data" class="hidden" style="text-align:center; padding:20px; color:#666">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</div>

                <h2 style="margin-top:30px;">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
                <div class="card-container" id="history-list-container" style="min-height: 50px;"></div>
                <div id="btn-load-more" class="load-more-btn hidden" onclick="loadMoreHistory()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ...</div>
            </div>

            <!-- ASSETS PAGE -->
            <div id="page-assets" class="page-view">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1 style="margin:0">–ê–∫—Ç–∏–≤—ã</h1>
                    <div onclick="openAddWalletPage()" style="color:var(--accent-blue); font-size:28px; cursor:pointer; font-weight:300; padding: 0 10px;">+</div>
                </div>
                
                <div class="balance-display-card" style="background: linear-gradient(135deg, #2A2A2D 0%, #38383A 100%);">
                    <div class="balance-title">–ß–∏—Å—Ç—ã–π –∫–∞–ø–∏—Ç–∞–ª (Net Worth)</div>
                    <div id="display-net-worth" class="balance-amount">...</div>
                </div>

                <!-- SAFETY NET WIDGET -->
                <div id="safety-net-widget" class="safety-net-card hidden">
                    <div class="safety-header">
                        <div class="safety-title"><span class="safety-icon">üõ°</span>–ü–æ–¥—É—à–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</div>
                        <div id="safety-percent" style="font-weight: 700; color: var(--accent-green);">0%</div>
                    </div>
                    <div class="safety-progress-bg">
                        <div id="safety-bar" class="safety-progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="safety-stats">
                        <span id="safety-current">0 ‚ÇΩ</span>
                        <span id="safety-goal">–¶–µ–ª—å: 0 ‚ÇΩ</span>
                    </div>
                    <div id="safety-message" style="margin-top: 10px; font-size: 12px; color: #8E8E93; line-height: 1.4;">
                        –í–∞—à –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –Ω–∞–∫–æ–ø–∏—Ç—å —Ä–µ–∑–µ—Ä–≤.
                    </div>
                </div>
                
                <h2>–ö–æ—à–µ–ª—å–∫–∏</h2>
                <div id="wallets-list-container"></div>
                <p style="color:#666; font-size:13px; text-align:center; margin-top:20px;">
                    –ß–∏—Å—Ç—ã–π –∫–∞–ø–∏—Ç–∞–ª = (–ö–æ—à–µ–ª—å–∫–∏ + –ú–Ω–µ –¥–æ–ª–∂–Ω—ã) - (–Ø –¥–æ–ª–∂–µ–Ω)
                </p>
            </div>

            <!-- ADD WALLET PAGE -->
            <div id="page-add-wallet" class="page-view">
                <div style="margin-bottom:20px;">
                    <div onclick="navigateToPage('page-assets')" style="color:var(--accent-blue); font-size:17px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</div>
                </div>
                <h1>–ù–æ–≤—ã–π –∫–æ—à–µ–ª–µ–∫</h1>
                <div class="card-container">
                    <div class="list-item-row">
                        <div class="row-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                        <input type="text" id="input-wallet-name" class="row-input" placeholder="–ö–∞—Ä—Ç–∞ –¢–∏–Ω—å–∫–æ—Ñ—Ñ">
                    </div>
                    <div class="list-item-row">
                        <div class="row-label">–ë–∞–ª–∞–Ω—Å</div>
                        <input type="number" id="input-wallet-balance" class="row-input" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="list-item-row">
                        <div class="row-label">–¢–∏–ø</div>
                        <input type="text" id="input-wallet-type" class="row-input" placeholder="–ë–∞–Ω–∫">
                    </div>
                    <div class="list-item-row">
                        <div class="row-label">–°—á–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="input-wallet-is-default" class="toggle-switch-checkbox">
                            <span class="toggle-switch-label"></span>
                        </label>
                    </div>
                </div>
                <button onclick="saveWallet()" class="button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <!-- DEBTS PAGE -->
            <div id="page-debts" class="page-view">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1 style="margin:0">–î–æ–ª–≥–∏</h1>
                    <div onclick="openAddDebtPage()" style="color:var(--accent-blue); font-size:28px; cursor:pointer; font-weight:300; padding: 0 10px;">+</div>
                </div>

                <div class="statistics-grid">
                    <div class="stat-item-box" style="border: 1px solid rgba(255, 69, 58, 0.3);">
                        <div class="stat-item-label">–Ø –¥–æ–ª–∂–µ–Ω</div>
                        <div id="display-total-owe" class="stat-item-value text-red">0</div>
                    </div>
                    <div class="stat-item-box" style="border: 1px solid rgba(48, 209, 88, 0.3);">
                        <div class="stat-item-label">–ú–Ω–µ –¥–æ–ª–∂–Ω—ã</div>
                        <div id="display-total-owed-me" class="stat-item-value text-green">0</div>
                    </div>
                </div>

                <!-- STRATEGY DASHBOARD -->
                <div class="strategy-info-box">
                    <div>
                        <div style="font-size:12px; color:#8E8E93;">–î–∞—Ç–∞ —Å–≤–æ–±–æ–¥—ã</div>
                        <div id="display-freedom-date" style="font-size:16px; font-weight:600; color:#FFF;">...</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:12px; color:#8E8E93;">–°—Ç—Ä–∞—Ç–µ–≥–∏—è</div>
                        <div style="font-size:16px; font-weight:600; color:var(--accent-orange);">–õ–∞–≤–∏–Ω–∞</div>
                    </div>
                </div>
                
                <div style="margin-bottom:20px;">
                    <div class="btn-sim" onclick="openSim()" style="width:100%; justify-content:center; padding:12px;">
                        ‚ö°Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–º—É–ª—è—Ç–æ—Ä
                    </div>
                </div>

                <div style="text-align:center; margin-bottom:20px;">
                    <div class="pain-badge">üî• –ü–æ—Ç–µ—Ä–∏ —Å–µ–≥–æ–¥–Ω—è: <span id="display-daily-pain" style="margin-left:4px;">0 ‚ÇΩ</span></div>
                </div>

                <h2>–ú–æ–∏ –∫—Ä–µ–¥–∏—Ç—ã</h2>
                <div id="credits-list-container"></div>
                <h2>–ú–Ω–µ –¥–æ–ª–∂–Ω—ã</h2>
                <div id="debits-list-container"></div>
            </div>

            <!-- ADD DEBT PAGE -->
            <div id="page-add-debt" class="page-view">
                <div style="margin-bottom:20px;">
                    <div onclick="navigateToPage('page-debts')" style="color:var(--accent-blue); font-size:17px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</div>
                </div>
                <h1>–ù–æ–≤—ã–π –¥–æ–ª–≥</h1>
                <div class="card-container">
                    <div class="list-item-row">
                        <div class="row-label">–¢–∏–ø</div>
                        <div class="segment-control-container" style="margin:0; width:200px;">
                            <div class="segment-button active" onclick="setDebtType('credit', this)">–Ø –≤–∑—è–ª</div>
                            <div class="segment-button" onclick="setDebtType('debit', this)">–Ø –¥–∞–ª</div>
                        </div>
                    </div>
                    <div class="list-item-row">
                        <div class="row-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                        <input type="text" id="input-debt-name" class="row-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—Ä–µ–¥–∏—Ç–∫–∞">
                    </div>
                    <div class="list-item-row">
                        <div class="row-label">–°—É–º–º–∞</div>
                        <input type="number" id="input-debt-amount" class="row-input" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="list-item-row">
                        <div class="row-label">–°—Ç–∞–≤–∫–∞ (%)</div>
                        <input type="number" id="input-debt-rate" class="row-input" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="list-item-row">
                        <div class="row-label">–ú–∏–Ω. –ø–ª–∞—Ç–µ–∂</div>
                        <input type="number" id="input-debt-min-payment" class="row-input" placeholder="0" inputmode="decimal">
                    </div>
                </div>
                <p style="color:#666; font-size:13px; padding:0 10px;">–î–ª—è –±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –¥–æ–ª–≥–æ–≤ —Å—Ç–∞–≤—å—Ç–µ 0%.</p>
                <button onclick="saveDebt()" class="button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <!-- ADD TRANSACTION PAGE -->
            <div id="page-add" class="page-view">
                <h1 id="add-page-title">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h1>
                
                <div class="segment-control-container" style="margin-bottom: 24px;">
                    <div class="segment-button active" onclick="setTransactionType('expense', this)">–†–∞—Å—Ö–æ–¥</div>
                    <div class="segment-button" onclick="setTransactionType('income', this)">–î–æ—Ö–æ–¥</div>
                    <div class="segment-button" onclick="setTransactionType('transfer', this)">–ü–µ—Ä–µ–≤–æ–¥</div>
                </div>

                <div class="card-container">
                    <div class="list-item-row">
                        <div class="row-label">–°—É–º–º–∞</div>
                        <input type="number" id="input-transaction-amount" class="row-input" placeholder="0" inputmode="decimal" autofocus>
                    </div>
                    
                    <!-- IMPACT ANALYSIS WIDGET -->
                    <div id="expense-impact-container" class="impact-warning hidden">
                        <span>‚è≥ –ê–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è...</span>
                    </div>

                    <div id="row-category" class="list-item-row" onclick="openCategorySelectionModal()" style="cursor: pointer;">
                        <div class="row-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                        <div class="row-select-indicator"><span id="display-selected-category">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span><span class="chevron-icon">‚Ä∫</span></div>
                    </div>
                    
                    <div class="list-item-row" onclick="openWalletSelectionModal('from')" style="cursor: pointer;">
                        <div id="label-wallet-from" class="row-label">–°—á–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è</div>
                        <div class="row-select-indicator">
                            <span id="display-selected-wallet" style="color:var(--text-primary); font-size:15px;">–û—Å–Ω–æ–≤–Ω–æ–π</span>
                            <span class="chevron-icon">‚Ä∫</span>
                        </div>
                    </div>

                    <div id="row-wallet-to" class="list-item-row hidden" onclick="openWalletSelectionModal('to')" style="cursor: pointer;">
                        <div class="row-label">–ö—É–¥–∞ –∑–∞—á–∏—Å–ª–∏—Ç—å</div>
                        <div class="row-select-indicator">
                            <span id="display-wallet-to">–í—ã–±—Ä–∞—Ç—å</span>
                            <span class="chevron-icon">‚Ä∫</span>
                        </div>
                    </div>

                    <div class="list-item-row">
                        <div class="row-label">–î–∞—Ç–∞</div>
                        <input type="date" id="input-transaction-date" class="row-input" style="color: var(--text-primary); min-width: 130px;">
                    </div>
                    <div class="list-item-row">
                        <div class="row-label">–ó–∞–º–µ—Ç–∫–∞</div>
                        <input type="text" id="input-transaction-comment" class="row-input" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                    </div>
                </div>
                
                <div id="edit-mode-indicator" class="hidden" style="text-align:center; margin-bottom:10px; color:#888; font-size:13px;">–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏</div>
                <button id="button-cancel-edit" class="button-primary hidden" style="background:#333; margin-top:0;" onclick="cancelEditMode()">–û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</button>
                <div style="padding: 0 12px; color: #666; font-size: 13px; text-align: center; line-height: 1.4; margin-top: 20px;">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.</div>
            </div>

            <!-- SETTINGS PAGE (REDESIGNED) -->
            <div id="page-settings" class="page-view">
                <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                
                <div class="settings-header-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
                <div class="settings-section">
                    <div class="settings-card">
                        <div class="settings-row interactive-row" onclick="inviteFamilyMember()">
                            <div class="settings-label-block">
                                <div class="settings-icon" style="background: linear-gradient(135deg, #0A84FF, #64D2FF);">üë®‚Äçüë©‚Äçüëß</div>
                                <div>
                                    <div class="settings-title">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–µ–º—å—é</div>
                                    <div class="settings-hint">–î–æ—Å—Ç—É–ø –∫ –æ–±—â–∏–º —Ñ–∏–Ω–∞–Ω—Å–∞–º</div>
                                </div>
                            </div>
                            <span class="settings-arrow">‚Ä∫</span>
                        </div>
                        <div class="settings-row interactive-row" onclick="openSubscriptionsPage()">
                            <div class="settings-label-block">
                                <div class="settings-icon" style="background: linear-gradient(135deg, #BF5AF2, #C9A9FF);">üìÖ</div>
                                <div>
                                    <div class="settings-title">–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏</div>
                                    <div class="settings-hint">–ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –æ–ø–ª–∞—Ç</div>
                                </div>
                            </div>
                            <span class="settings-arrow">‚Ä∫</span>
                        </div>
                        <div class="settings-row interactive-row" onclick="forceUpdateStructure()">
                            <div class="settings-label-block">
                                <div class="settings-icon" style="background: linear-gradient(135deg, #3A3A3C, #1C1C1E);">üõ†Ô∏è</div>
                                <div>
                                    <div class="settings-title">–û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</div>
                                    <div class="settings-hint">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Sheet</div>
                                </div>
                            </div>
                            <span class="settings-arrow">‚Ä∫</span>
                        </div>
                    </div>
                </div>

                <h2 id="family-list-title" class="hidden settings-header-label">–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–µ–º—å–∏</h2>
                <div class="card-container hidden" id="family-list-container"></div>

                <div class="settings-header-label">–§–∏–Ω–∞–Ω—Å—ã</div>
                <div class="settings-section">
                    <div class="settings-card" style="padding: 14px 16px 8px 16px; display:flex; flex-direction:column; gap: 10px;">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                            <div>
                                <div class="settings-title">–¶–µ–ª—å –ø–æ–¥—É—à–∫–∏ (‚ÇΩ)</div>
                                <div class="settings-hint">–°—É–º–º–∞ –¥–æ —Å—Ç–∞—Ä—Ç–∞ –¥–æ—Å—Ä–æ—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</div>
                            </div>
                            <div class="settings-icon" style="background: linear-gradient(135deg, #34C759, #0FB57E);">üõ°</div>
                        </div>
                        <div class="modal-input-wrap" style="justify-content:flex-start; padding: 12px 14px;">
                            <span style="color: var(--text-secondary); font-weight:600;">‚ÇΩ</span>
                            <input
                                type="number"
                                id="input-settings-emergency"
                                class="modal-input"
                                style="text-align:left; font-size: 18px;"
                                placeholder="0"
                                inputmode="numeric"
                                onchange="saveEmergencyGoal(this.value)"
                            >
                        </div>
                        <p class="settings-note">–°–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–≤–µ—Ä—Ö —ç—Ç–æ–π —Å—É–º–º—ã –Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–æ–ª–≥–æ–≤.</p>
                    </div>
                </div>

                <div class="settings-header-label">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</div>
                
                <!-- NEW CREATE CATEGORY BLOCK -->
                <div class="settings-section">
                    <div class="settings-card" style="padding: 16px; display:flex; flex-direction:column; gap:12px;">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div>
                                <div class="settings-title">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                                <div class="settings-hint">–ü–æ–º–æ–∂–µ—Ç —Ç–æ—á–Ω–µ–µ –≤–µ—Å—Ç–∏ —É—á–µ—Ç</div>
                            </div>
                            <div class="settings-icon" style="background: linear-gradient(135deg, #FF9F0A, #FF6B6B);">‚ûï</div>
                        </div>
                        <input type="text" id="input-new-category-name" class="input-large-block" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–¥—É–∫—Ç—ã" style="margin-bottom: 8px;">

                        <div class="segment-control-container" style="margin-bottom: 8px;">
                            <div class="segment-button active" onclick="setNewCategoryType('expense', this)">–†–∞—Å—Ö–æ–¥</div>
                            <div class="segment-button" onclick="setNewCategoryType('income', this)">–î–æ—Ö–æ–¥</div>
                        </div>

                        <button id="button-create-category" class="button-primary" style="margin-top:4px;">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                    </div>
                </div>

                <div class="settings-header-label">–ú–æ–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                <div class="settings-card" id="settings-categories-list"></div>
            </div>

            <!-- SUBSCRIPTIONS PAGE -->
            <div id="page-subscriptions" class="page-view">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div onclick="navigateToPage('page-settings')" style="color:var(--accent-blue); font-size:17px; cursor:pointer;">&larr; –ù–∞–∑–∞–¥</div>
                    <div onclick="openAddSubscriptionPage()" style="color:var(--accent-blue); font-size:28px; cursor:pointer; font-weight:300; padding:0 10px;">+</div>
                </div>
                <h1>–ü–æ–¥–ø–∏—Å–∫–∏</h1>
                <p style="color:#8E8E93; font-size:13px; margin-bottom:20px;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –¥–µ–Ω—å –æ–ø–ª–∞—Ç—ã.</p>
                <div id="subscriptions-list-container" class="card-container"></div>
            </div>

            <!-- ADD SUBSCRIPTION PAGE -->
            <div id="page-add-subscription" class="page-view">
                <div style="margin-bottom:20px;">
                    <div onclick="navigateToPage('page-subscriptions')" style="color:var(--accent-blue); font-size:17px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</div>
                </div>
                <h1>–ù–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</h1>
                <div class="card-container">
                    <div class="list-item-row">
                        <div class="row-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                        <input type="text" id="input-sub-name" class="row-input" placeholder="Netflix">
                    </div>
                    <div class="list-item-row">
                        <div class="row-label">–°—É–º–º–∞</div>
                        <input type="number" id="input-sub-amount" class="row-input" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="list-item-row" onclick="openCategorySelectionModal()" style="cursor: pointer;">
                        <div class="row-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                        <div class="row-select-indicator"><span id="display-selected-category-sub">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</span><span class="chevron-icon">‚Ä∫</span></div>
                    </div>
                    <div class="list-item-row">
                        <div class="row-label">–î–µ–Ω—å –æ–ø–ª–∞—Ç—ã</div>
                        <input type="number" id="input-sub-day" class="row-input" placeholder="1-31" min="1" max="31">
                    </div>
                </div>
                <button onclick="saveSubscription()" class="button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

        </div> 
        
        <!-- NAVBAR -->
        <div class="bottom-navbar">
            <div class="navbar-item active" onclick="navigateToPage('page-home', this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>–°–≤–æ–¥–∫–∞</span></div>
            <div class="navbar-item" onclick="navigateToPage('page-assets', this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg><span>–ê–∫—Ç–∏–≤—ã</span></div>
            <div class="navbar-item" onclick="navigateToPage('page-debts', this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.5 1L2 6v2h19V6l-9.5-5zM2 19h19v2H2v-2zm3-11h2v8H5V8zm12 0h2v8h-2V8zm-6 0h2v8h-2V8z"/></svg><span>–î–æ–ª–≥–∏</span></div>
            <div class="navbar-item" onclick="navigateToPage('page-add', this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg><span>–ó–∞–ø–∏—Å—å</span></div>
            <div class="navbar-item" onclick="navigateToPage('page-settings', this)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content-sheet">
            <div class="modal-handle"></div>
            <div class="modal-topbar" style="padding-bottom: 12px;">
                <div>
                    <h2 class="modal-heading" id="modal-header-title">–í—ã–±–æ—Ä</h2>
                    <p class="modal-subheading">–û—Ç–º–µ—Ç—å—Ç–µ –Ω—É–∂–Ω—ã–π –ø—É–Ω–∫—Ç</p>
                </div>
                <div class="modal-close" onclick="modalOverlay.classList.remove('visible')">–ì–æ—Ç–æ–≤–æ</div>
            </div>
            <div id="modal-list-container" class="modal-scroll-area" style="padding: 0 10px 14px 10px;"></div>
        </div>
    </div>

    <!-- REPAY MODAL -->
    <div id="repay-modal-overlay" class="modal-overlay" style="justify-content: center; align-items: center; padding: 20px;">
        <div class="modal-centered">
            <div class="modal-handle" style="margin-top: 16px;"></div>
            <div style="padding: 10px 24px 4px 24px; text-align: center;">
                <h3 id="repay-modal-title" style="margin: 0 0 6px 0;">–ü–æ–≥–∞—à–µ–Ω–∏–µ</h3>
                <p id="repay-modal-subtitle" style="color: var(--text-secondary); font-size: 14px; margin: 0;">–°–∫–æ–ª—å–∫–æ –≤–Ω–µ—Å—Ç–∏?</p>
            </div>
            <div class="modal-body" style="gap: 16px;">
                <div>
                    <label class="modal-label">–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞</label>
                    <div class="modal-input-wrap" style="justify-content:center;">
                        <input type="number" id="input-repay-amount" class="modal-input" placeholder="0">
                        <span style="color: var(--text-secondary);">‚ÇΩ</span>
                    </div>
                </div>
            </div>
            <div class="modal-divider"></div>
            <div class="modal-actions" style="padding: 16px 24px 20px 24px;">
                <button class="ghost-button" onclick="closeRepayModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="ghost-button primary" onclick="confirmRepayDebt()">–í–Ω–µ—Å—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- BUDGET MODAL -->
    <div id="budget-modal-overlay" class="modal-overlay" style="justify-content: center; align-items: center; padding: 20px;">
        <div class="modal-centered">
            <div class="modal-handle" style="margin-top: 16px;"></div>
            <div style="padding: 10px 24px 4px 24px; text-align: center;">
                <h3 id="budget-modal-title" style="margin: 0 0 6px 0;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
                <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ—Å—è—á–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞</p>
            </div>
            <div class="modal-body" style="gap: 14px;">
                <div id="budget-stats-container" class="modal-card" style="margin: 0 6px;">
                    <div style="text-align: center; color: var(--text-secondary); font-size: 13px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
                </div>
                <div>
                    <label class="modal-label">–ù–æ–≤—ã–π –ª–∏–º–∏—Ç</label>
                    <div class="modal-input-wrap" style="justify-content:center;">
                        <input type="number" id="input-budget-limit" class="modal-input" placeholder="0">
                        <span style="color: var(--text-secondary);">‚ÇΩ</span>
                    </div>
                </div>
            </div>
            <div class="modal-divider"></div>
            <div class="modal-actions" style="padding: 16px 24px 20px 24px;">
                <button class="ghost-button" onclick="closeBudgetModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="ghost-button primary" onclick="saveBudgetFromModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- RECONCILE MODAL -->
    <div id="reconcile-modal-overlay" class="modal-overlay" style="justify-content: center; align-items: center; padding: 20px;">
        <div class="modal-centered">
            <div class="modal-handle" style="margin-top: 16px;"></div>
            <div style="padding: 10px 24px 4px 24px; text-align: center;">
                <h3 style="margin: 0 0 6px 0;">–°–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞</h3>
                <p id="reconcile-wallet-name" style="color: var(--text-secondary); font-size: 14px; margin: 0;">...</p>
            </div>
            <div class="modal-body" style="gap: 16px;">
                <div>
                    <label class="modal-label">–†–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</label>
                    <div class="modal-input-wrap" style="justify-content:center;">
                        <input type="number" id="input-reconcile-amount" class="modal-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É">
                        <span style="color: var(--text-secondary);">‚ÇΩ</span>
                    </div>
                </div>
            </div>
            <div class="modal-divider"></div>
            <div class="modal-actions" style="padding: 16px 24px 20px 24px;">
                <button class="ghost-button" onclick="closeReconcileModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="ghost-button primary" onclick="confirmReconcile()">–°–≤–µ—Ä–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const YANDEX_FUNCTION_URL = "https://functions.yandexcloud.net/d4eq15gjje0ijg3mgshd"; 
        const BOT_USERNAME = "ABAtabulabot"; 

        const TelegramWebApp = window.Telegram.WebApp;
        const CHART_COLORS = ['#FF453A', '#FF9F0A', '#FFD60A', '#30D158', '#64D2FF', '#0A84FF', '#BF5AF2'];
        
        let categoriesList = [];
        let walletsList = [];
        let summaryData = null;
        let currentChartMode = 'expense';
        let newCategoryTypeMode = 'expense';
        let selectedCategoryId = null;
        let selectedWalletId = null;
        let selectedWalletToId = null; 
        let reconcileWalletId = null;
        let currentDate = new Date();
        let editingTransactionId = null;
        let myTelegramId = null;
        let currentBudgetCategoryId = null;
        let currentHistoryOffset = 0;
        let debtTypeMode = 'credit'; 
        let currentRepayDebtId = null;
        
        let globalDebts = [];
        let baseFreedomMonths = 0;
        let baseTotalInterest = 0;
        
        let transactionType = 'expense'; 
        let walletSelectionMode = 'from'; 

        const currencyFormatter = (number) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(number);

        // --- IMPULSE BUY LOGIC (V3.6) ---
        function openImpulseModal() {
            document.getElementById('impulse-modal').classList.add('visible');
            document.getElementById('input-impulse-amount').value = '';
            document.getElementById('input-impulse-amount').focus();
            document.getElementById('impulse-results').classList.add('hidden');
            document.getElementById('impulse-loading').classList.add('hidden');
        }

        function closeImpulseModal() { document.getElementById('impulse-modal').classList.remove('visible'); }

        let impulseTimer;
        function checkImpulse(val) {
            document.getElementById('impulse-results').classList.add('hidden');
            if(!val || val <= 0) return;
            
            document.getElementById('impulse-loading').classList.remove('hidden');
            clearTimeout(impulseTimer);
            impulseTimer = setTimeout(() => {
                callApi('calculate_expense_impact', { amount: val }).then(res => {
                    document.getElementById('impulse-loading').classList.add('hidden');
                    document.getElementById('impulse-results').classList.remove('hidden');
                    
                    document.getElementById('impulse-res-percent').innerText = `${res.percentage}%`;
                    document.getElementById('impulse-res-lost').innerText = `${currencyFormatter(res.interest_cost).replace('‚ÇΩ','')} ‚ÇΩ`;
                    
                    if(res.days_delayed > 0) {
                        document.getElementById('impulse-res-text').innerText = `–≠—Ç–∞ –ø–æ–∫—É–ø–∫–∞ –æ—Ç–æ–¥–≤–∏–Ω–µ—Ç –≤–∞—à—É —Å–≤–æ–±–æ–¥—É –Ω–∞ ${Math.round(res.days_delayed)} –¥–Ω–µ–π.`;
                    } else {
                        document.getElementById('impulse-res-text').innerText = `–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å—Ä–æ–∫ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ –≤—ã —Ç–µ—Ä—è–µ—Ç–µ –¥–µ–Ω—å–≥–∏ –Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö.`;
                    }
                });
            }, 600);
        }

        function proceedToBuy() {
            const amt = document.getElementById('input-impulse-amount').value;
            closeImpulseModal();
            document.getElementById('input-transaction-amount').value = amt;
            navigateToPage('page-add');
        }

        function proceedToRepay() {
            closeImpulseModal();
            navigateToPage('page-debts');
        }
        
        // --- SAFETY NET SETTINGS LOGIC (V3.7) ---
        async function saveEmergencyGoal(val) {
            if(val < 0) return;
            try {
                await callApi('save_settings', { key: 'emergency_fund_goal', value: val });
                TelegramWebApp.HapticFeedback.notificationOccurred('success');
            } catch(e) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
        }

        // --- UI UTILS ---
        document.addEventListener('focusin', function(e) {
            if (e.target.classList.contains('row-input')) {
                const row = e.target.closest('.list-item-row');
                if (row) row.classList.add('is-focused');
            }
        });

        document.addEventListener('focusout', function(e) {
            if (e.target.classList.contains('row-input')) {
                const row = e.target.closest('.list-item-row');
                if (row) row.classList.remove('is-focused');
            }
        });

        async function callApi(actionName, payloadData = {}) {
            try {
                const response = await fetch(YANDEX_FUNCTION_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: actionName, initData: TelegramWebApp.initData, payload: payloadData })
                });
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                return await response.json();
            } catch (error) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞: " + error.message); throw error; }
        }

        // --- NAVIGATION ---
        function navigateToPage(pageId, navElement) {
            document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.navbar-item').forEach(item => item.classList.remove('active'));
            if (navElement) navElement.classList.add('active');
            TelegramWebApp.MainButton.hide();
            
            if (pageId === 'page-home') { cancelEditMode(); refreshHomePage(); }
            if (pageId === 'page-assets') { loadAssets(); }
            if (pageId === 'page-debts') { loadDebts(); }
            
            if (pageId === 'page-add') {
                TelegramWebApp.MainButton.setText(editingTransactionId ? "–û–ë–ù–û–í–ò–¢–¨" : "–°–û–•–†–ê–ù–ò–¢–¨").show();
                TelegramWebApp.MainButton.setParams({ color: editingTransactionId ? '#FF9F0A' : '#0A84FF', text_color:'#FFFFFF' });
                
                if (!editingTransactionId) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    document.getElementById('input-transaction-date').value = `${year}-${month}-${day}`;
                    setTransactionType('expense', document.querySelectorAll('.segment-control-container .segment-button')[0]);
                }
                
                if(!editingTransactionId) {
                    selectedWalletId = null; selectedWalletToId = null;
                    document.getElementById('display-selected-wallet').innerText = "–û—Å–Ω–æ–≤–Ω–æ–π";
                    document.getElementById('display-selected-wallet').style.color = '#8E8E93';
                    document.getElementById('display-wallet-to').innerText = "–í—ã–±—Ä–∞—Ç—å";
                    document.getElementById('display-wallet-to').style.color = '#8E8E93';
                }
            }
            if (pageId === 'page-settings') renderSettingsPage();
        }

        function changeMonth(deltaMonths) { currentDate.setMonth(currentDate.getMonth() + deltaMonths); refreshHomePage(); }

        // --- TRANSACTION TYPE LOGIC ---
        function setTransactionType(type, el) {
            transactionType = type;
            el.parentElement.querySelectorAll('.segment-button').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active');
            
            selectedCategoryId = null;
            document.getElementById('display-selected-category').innerText = '–ù–µ –≤—ã–±—Ä–∞–Ω–æ';
            document.getElementById('display-selected-category').style.color = '#8E8E93';
            
            // Hide impact warning when switching away from expense
            document.getElementById('expense-impact-container').classList.add('hidden');

            const rowCategory = document.getElementById('row-category');
            const rowWalletTo = document.getElementById('row-wallet-to');
            const labelWalletFrom = document.getElementById('label-wallet-from');
            
            if (type === 'transfer') {
                rowCategory.classList.add('hidden');
                rowWalletTo.classList.remove('hidden');
                labelWalletFrom.innerText = "–û—Ç–∫—É–¥–∞";
            } else {
                rowCategory.classList.remove('hidden');
                rowWalletTo.classList.add('hidden');
                labelWalletFrom.innerText = "–°—á–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è";
            }
        }

        // --- HOME PAGE ---
        async function refreshHomePage() {
            const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
            document.getElementById('current-date-display').innerText = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            document.getElementById('history-list-container').innerHTML = '';
            document.getElementById('btn-load-more').classList.add('hidden');
            currentHistoryOffset = 0;
            
            try {
                summaryData = await callApi('get_summary', { month: currentDate.getMonth() + 1, year: currentDate.getFullYear() });
                
                document.getElementById('display-balance-value').innerText = currencyFormatter(summaryData.balance);
                document.getElementById('display-income-value').innerText = "+" + currencyFormatter(summaryData.income).replace('‚ÇΩ','');
                document.getElementById('display-expense-value').innerText = "-" + currencyFormatter(Math.abs(summaryData.expense)).replace('‚ÇΩ','');
                
                if (summaryData.analytics) {
                    document.getElementById('display-daily-value').innerText = currencyFormatter(summaryData.analytics.daily_avg).replace('‚ÇΩ','');
                    document.getElementById('display-forecast-value').innerText = currencyFormatter(summaryData.analytics.monthly_forecast).replace('‚ÇΩ','');
                } else {
                    document.getElementById('display-daily-value').innerText = "‚Äî";
                    document.getElementById('display-forecast-value').innerText = "‚Äî";
                }

                renderDonutChart(); 
                renderHistoryBatch(summaryData.history);
                
                if (summaryData.has_more) {
                    document.getElementById('btn-load-more').classList.remove('hidden');
                    currentHistoryOffset = 20;
                }

            } catch (error) { console.error(error); }
        }

        async function loadMoreHistory() {
            const btn = document.getElementById('btn-load-more');
            btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            try {
                const newData = await callApi('get_history', { month: currentDate.getMonth() + 1, year: currentDate.getFullYear(), offset: currentHistoryOffset });
                if (newData && newData.length > 0) {
                    renderHistoryBatch(newData);
                    currentHistoryOffset += 20;
                    btn.innerText = "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ...";
                    if (newData.length < 20) btn.classList.add('hidden');
                } else { btn.classList.add('hidden'); }
            } catch (e) { btn.innerText = "–û—à–∏–±–∫–∞"; }
        }

        function renderHistoryBatch(items) {
            const container = document.getElementById('history-list-container');
            if (!items || items.length === 0) {
                if (container.children.length === 0) container.innerHTML = '<div style="padding:15px;text-align:center;color:#666;font-size:14px;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</div>';
                return;
            }
            items.forEach(t => {
                const isExp = t.amount < 0;
                const color = isExp ? '#FFFFFF' : '#30D158';
                const row = document.createElement('div'); row.className = 'list-item-row interactive-row';
                row.onclick = (e) => { if (!e.target.closest('.action-icon-button')) openEditMode(t); };
                row.innerHTML = `
                    <div class="history-list-item">
                        <div class="history-item-left"><div class="history-item-category">${t.category}</div><div class="history-item-meta">${t.date.split(' ')[0]} ${t.comment ? '‚Ä¢ '+t.comment : ''}</div></div>
                        <div class="history-item-right">
                            <div class="history-item-amount" style="color:${color}">${isExp?'':'+'}${currencyFormatter(t.amount).replace('‚ÇΩ','')}</div>
                            ${t.id ? `<div class="action-icon-button" onclick="deleteTransaction('${t.id}')">√ó</div>` : ''}
                        </div>
                    </div>`;
                container.appendChild(row);
            });
        }

        function setChartMode(mode, element) {
            element.parentElement.querySelectorAll('.segment-button').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active'); currentChartMode = mode; renderDonutChart();
        }

        function renderDonutChart() {
            if (!summaryData) return;
            const chartWrapper = document.getElementById('chart-container-wrapper');
            const emptyState = document.getElementById('state-empty-data');
            const legendList = document.getElementById('chart-legend-list');
            const donutElement = document.getElementById('donut-chart');

            let chartItems = summaryData.breakdown.filter(item => {
                if (currentChartMode === 'expense') return item.type === 'expense';
                return item.type === 'income';
            });
            chartItems.sort((a, b) => Math.abs(parseFloat(b.amount)) - Math.abs(parseFloat(a.amount)));
            const total = chartItems.reduce((acc, item) => acc + Math.abs(parseFloat(item.amount)), 0);
            document.getElementById('display-chart-total').innerText = currencyFormatter(total).replace('‚ÇΩ','');

            if (total === 0) { chartWrapper.classList.add('hidden'); emptyState.classList.remove('hidden'); return; }
            chartWrapper.classList.remove('hidden'); emptyState.classList.add('hidden'); legendList.innerHTML = '';

            let gradients = [], startAngle = 0;
            chartItems.forEach((item, index) => {
                const color = CHART_COLORS[index % CHART_COLORS.length];
                const val = Math.abs(parseFloat(item.amount));
                const pct = (val / total) * 100;
                let limitHtml = '';
                if (currentChartMode === 'expense') {
                    if (item.limit > 0) {
                        const limitPct = Math.min((val / item.limit) * 100, 100);
                        const isOver = val > item.limit;
                        const diff = item.limit - val;
                        limitHtml = `<div class="progress-track"><div class="progress-fill" style="width:${limitPct}%; background:${isOver ? 'var(--accent-red)' : color}"></div></div><div class="limit-info"><span>–õ–∏–º–∏—Ç: ${currencyFormatter(item.limit).replace('‚ÇΩ','')}</span><span>${isOver ? '–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ' : '–û—Å—Ç–∞–ª–æ—Å—å'}: ${currencyFormatter(Math.abs(diff))}</span></div>`;
                    } else { limitHtml = `<div style="font-size:11px; color:#38383A; margin-top:6px;">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –±—é–¥–∂–µ—Ç</div>`; }
                }
                gradients.push(`${color} ${startAngle}deg ${startAngle + (pct * 3.6)}deg`); startAngle += (pct * 3.6);
                
                legendList.innerHTML += `
                <div class="card-container interactive-row" style="margin-bottom:10px; padding:12px; border-radius:10px; background:rgba(28,28,30,0.5);" onclick="promptSetLimit('${item.id}', '${item.category}', ${item.limit})">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex;align-items:center;"><div class="category-color-dot" style="background:${color}"></div><span style="font-size:17px">${item.category}</span></div>
                        <div style="text-align:right;"><span style="font-weight:600;">${currencyFormatter(val).replace('‚ÇΩ','')}</span><div class="percentage-badge" style="display:inline-block">${Math.round(pct)}%</div></div>
                    </div>
                    ${limitHtml}
                </div>`;
            });
            donutElement.style.background = `conic-gradient(${gradients.join(', ')})`;
        }

        /* --- ASSETS LOGIC (UPDATED V3.7) --- */
        async function loadAssets() {
            const container = document.getElementById('wallets-list-container');
            container.innerHTML = '<div style="padding:10px;text-align:center;color:#666">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤...</div>';
            document.getElementById('display-net-worth').innerText = '...';
            try {
                // Fetch Wallets AND Debts (to get safety net info calculated on backend)
                const [wData, dData] = await Promise.all([
                    callApi('get_wallets'),
                    callApi('get_debts')
                ]); 
                
                walletsList = wData.wallets;
                document.getElementById('display-net-worth').innerText = currencyFormatter(wData.net_worth);
                
                // SAFETY NET WIDGET LOGIC
                const widget = document.getElementById('safety-net-widget');
                const goal = dData.emergency_fund ? dData.emergency_fund.goal : 0;
                const current = dData.emergency_fund ? dData.emergency_fund.current : 0;

                if (goal > 0) {
                    widget.classList.remove('hidden');
                    const pct = Math.min((current / goal) * 100, 100);
                    document.getElementById('safety-bar').style.width = `${pct}%`;
                    document.getElementById('safety-percent').innerText = `${Math.round(pct)}%`;
                    document.getElementById('safety-current').innerText = currencyFormatter(current);
                    document.getElementById('safety-goal').innerText = `–¶–µ–ª—å: ${currencyFormatter(goal)}`;
                    
                    if (pct >= 100) {
                        document.getElementById('safety-message').innerText = "‚úÖ –ü–æ–¥—É—à–∫–∞ —Å–æ–±—Ä–∞–Ω–∞! –¢–µ–ø–µ—Ä—å –∞—Ç–∞–∫—É–µ–º –¥–æ–ª–≥–∏.";
                        document.getElementById('safety-message').style.color = "var(--accent-green)";
                    } else {
                        document.getElementById('safety-message').innerText = "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∫–æ–ø–∏–º —Ä–µ–∑–µ—Ä–≤, —Ç–æ–ª—å–∫–æ –º–∏–Ω. –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º.";
                        document.getElementById('safety-message').style.color = "#8E8E93";
                    }
                } else {
                    widget.classList.add('hidden');
                }

                // Render Wallets
                container.innerHTML = '';
                if (walletsList.length === 0) { container.innerHTML = '<div class="card-container" style="padding:20px; text-align:center; color:#888;">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∫–æ—à–µ–ª—å–∫–æ–≤. –ù–∞–∂–º–∏—Ç–µ "+", —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π.</div>'; return; }
                walletsList.forEach(w => {
                    const card = document.createElement('div');
                    card.className = 'card-container'; 
                    card.style.padding = '16px'; card.style.marginBottom = '12px';
                    card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><div style="font-size:17px; font-weight:500;">${w.name} ${w.is_default ? '<span style="font-size:12px; color:var(--accent-yellow);">‚òÖ</span>' : ''}</div><div style="font-size:18px; font-weight:600;">${currencyFormatter(w.balance)}</div></div><div style="margin-top:12px; display:flex; justify-content:flex-end;"><div style="background:rgba(255,255,255,0.1); padding:6px 12px; border-radius:6px; font-size:13px; cursor:pointer;" onclick="openReconcileModal('${w.uuid}', '${w.name}')">–°–≤–µ—Ä–∏—Ç—å</div></div>`;
                    container.appendChild(card);
                });
            } catch (e) { container.innerHTML = '<div style="text-align:center; color:var(--accent-red);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; console.error(e); }
        }
        
        function openReconcileModal(uuid, name) { reconcileWalletId = uuid; document.getElementById('reconcile-wallet-name').innerText = name; document.getElementById('input-reconcile-amount').value = ''; document.getElementById('reconcile-modal-overlay').classList.add('visible'); document.getElementById('input-reconcile-amount').focus(); }
        function closeReconcileModal() { document.getElementById('reconcile-modal-overlay').classList.remove('visible'); reconcileWalletId = null; }
        async function confirmReconcile() {
            const val = document.getElementById('input-reconcile-amount').value;
            if(!val) return;
            closeReconcileModal(); TelegramWebApp.MainButton.showProgress();
            try { await callApi('reconcile_wallet', {wallet_uuid: reconcileWalletId, actual_balance: val}); await loadAssets(); TelegramWebApp.HapticFeedback.notificationOccurred('success'); } catch(e) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞ —Å–≤–µ—Ä–∫–∏"); }
            TelegramWebApp.MainButton.hideProgress();
        }

        function openAddWalletPage() { document.getElementById('input-wallet-name').value = ''; document.getElementById('input-wallet-balance').value = ''; document.getElementById('input-wallet-type').value = ''; document.getElementById('input-wallet-is-default').checked = false; navigateToPage('page-add-wallet'); }
        async function saveWallet() {
            const name = document.getElementById('input-wallet-name').value;
            const balance = document.getElementById('input-wallet-balance').value;
            const wallet_type = document.getElementById('input-wallet-type').value || 'bank_account';
            const is_default = document.getElementById('input-wallet-is-default').checked;
            if (!name || !balance) return TelegramWebApp.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –±–∞–ª–∞–Ω—Å");
            TelegramWebApp.MainButton.showProgress();
            try { await callApi('manage_wallet', { type: 'add', name, balance, wallet_type, is_default }); navigateToPage('page-assets'); } catch (e) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏"); }
            TelegramWebApp.MainButton.hideProgress();
        }
        
        /* --- DEBTS LOGIC (UPDATED V3.7) --- */
        async function loadDebts() {
            const creditsContainer = document.getElementById('credits-list-container');
            const debitsContainer = document.getElementById('debits-list-container');
            creditsContainer.innerHTML = '<div style="padding:10px;text-align:center;color:#666">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            debitsContainer.innerHTML = '';
            try {
                const data = await callApi('get_debts');
                
                globalDebts = data.items.filter(d => d.type === 'credit' && d.amount > 0);
                const baseSim = calculatePayoff(0);
                baseFreedomMonths = baseSim.months;
                baseTotalInterest = baseSim.interest;

                document.getElementById('display-total-owe').innerText = currencyFormatter(data.total_owe).replace('‚ÇΩ','');
                document.getElementById('display-total-owed-me').innerText = currencyFormatter(data.total_owed_me).replace('‚ÇΩ','');
                document.getElementById('display-daily-pain').innerText = currencyFormatter(data.daily_pain).replace('‚ÇΩ','');
                
                // --- STRATEGY BOX UPDATE ---
                const strategyBox = document.querySelector('.strategy-info-box');
                const isSafetyFirst = data.analytics.is_emergency_first;
                
                let strategyHtml = '';
                if (isSafetyFirst) {
                    const currentPct = Math.round(data.emergency_fund.current / data.emergency_fund.goal * 100);
                    strategyHtml = `
                    <div style="display:flex; justify-content:space-between; align-items:center; width:100%">
                        <div>
                            <div style="font-size:12px; color:#8E8E93;">–†–µ–∂–∏–º</div>
                            <div class="mode-badge mode-safety">üõ° –ö–æ–ø–∏–º –ø–æ–¥—É—à–∫—É</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:12px; color:#8E8E93;">–¶–µ–ª—å</div>
                            <div style="font-size:16px; font-weight:600; color:#FFF;">${currentPct > 100 ? 100 : currentPct}%</div>
                        </div>
                    </div>
                    <div style="width:100%; margin-top:10px; font-size:12px; color:#8E8E93; text-align:center;">
                        –í—Å–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∏–¥—É—Ç –≤ —Ä–µ–∑–µ—Ä–≤.
                    </div>`;
                } else {
                    strategyHtml = `
                    <div style="width:100%; display:flex; justify-content:space-between;">
                        <div>
                            <div style="font-size:12px; color:#8E8E93;">–î–∞—Ç–∞ —Å–≤–æ–±–æ–¥—ã</div>
                            <div style="font-size:16px; font-weight:600; color:#FFF;">${data.analytics.freedom_date}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:12px; color:#8E8E93;">–°—Ç—Ä–∞—Ç–µ–≥–∏—è</div>
                            <div class="mode-badge mode-attack">üî• –õ–∞–≤–∏–Ω–∞</div>
                        </div>
                    </div>`;
                }
                strategyBox.innerHTML = strategyHtml;
                
                creditsContainer.innerHTML = ''; 
                const credits = data.items.filter(d => d.type === 'credit');
                if(credits.length === 0) creditsContainer.innerHTML = '<div style="padding:10px;text-align:center;color:#666">–ù–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤</div>';
                else credits.forEach(d => {
                    const isTarget = (d.id === data.target_debt_id);
                    creditsContainer.appendChild(createDebtCard(d, isTarget));
                });

                const debits = data.items.filter(d => d.type === 'debit');
                if(debits.length === 0) debitsContainer.innerHTML = '<div style="padding:10px;text-align:center;color:#666">–ù–∏–∫—Ç–æ –Ω–µ –¥–æ–ª–∂–µ–Ω</div>';
                else debits.forEach(d => debitsContainer.appendChild(createDebtCard(d, false)));

            } catch(e) { console.error(e); }
        }

        function createDebtCard(d, isTarget) {
            const card = document.createElement('div');
            card.className = 'card-container';
            if (isTarget) { card.classList.add('target-debt-card'); }
            card.style.padding = '16px';
            
            const targetBadge = isTarget ? '<span class="target-badge">üéØ –¶–µ–ª—å</span>' : '';
            const minPayInfo = (d.type === 'credit' && d.min_payment > 0) ? `<div style="font-size:13px; color:#8E8E93; margin-top:4px;">–ú–∏–Ω: ${currencyFormatter(d.min_payment)}</div>` : '';

            card.innerHTML = `
                <div class="debt-card-header">
                    <span style="font-size:17px; font-weight:500;">${d.name} ${targetBadge}</span>
                    <span style="font-size:13px; color:#8E8E93;">${d.rate}%</span>
                </div>
                <div class="debt-amount-large">${currencyFormatter(d.amount)}</div>
                ${minPayInfo}
                <div class="debt-actions">
                    <div class="btn-small btn-pay" onclick="openRepayModal('${d.id}', '${d.name}')">–ü–æ–≥–∞—Å–∏—Ç—å</div>
                    <div class="btn-small btn-more" onclick="deleteDebt('${d.id}')">–ó–∞–∫—Ä—ã—Ç—å</div>
                </div>
            `;
            return card;
        }

        // --- SIMULATOR ---
        function openSim() {
            document.getElementById('sim-modal').classList.add('visible');
            updateSimulator(0); 
        }
        function closeSim() { document.getElementById('sim-modal').classList.remove('visible'); }

        function updateSimulator(val) {
            const extra = Number(val);
            document.getElementById('sim-display-amount').innerText = `+ ${extra.toLocaleString()} ‚ÇΩ`;
            
            const res = calculatePayoff(extra);
            const now = new Date();
            now.setMonth(now.getMonth() + res.months);
            const dateStr = now.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            const savedMonths = Math.max(0, baseFreedomMonths - res.months);
            const savedMoney = Math.max(0, baseTotalInterest - res.interest);

            document.getElementById('sim-res-date').innerHTML = `${dateStr} <br><span style="font-size:12px;color:#0A84FF">(-${savedMonths} –º–µ—Å)</span>`;
            document.getElementById('sim-res-saved').innerText = `${Math.round(savedMoney).toLocaleString()} ‚ÇΩ`;
        }

        function calculatePayoff(extraMoney) {
            let debts = JSON.parse(JSON.stringify(globalDebts));
            debts.sort((a, b) => b.rate - a.rate); 

            let months = 0;
            let totalInterest = 0;
            let loopGuard = 0;

            while (debts.some(d => d.amount > 1) && loopGuard < 400) {
                months++; loopGuard++;
                let monthlyBudget = Number(extraMoney); 

                for (let d of debts) {
                    if (d.amount > 0) {
                        let interest = d.amount * (d.rate / 100 / 12);
                        d.amount += interest;
                        totalInterest += interest;
                        let minPay = d.min_payment || 0;
                        let payment = Math.min(d.amount, minPay);
                        d.amount -= payment;
                        if (minPay > payment) monthlyBudget += (minPay - payment);
                    } else { monthlyBudget += (d.min_payment || 0); }
                }

                for (let d of debts) {
                    if (d.amount > 0) {
                        let pay = Math.min(d.amount, monthlyBudget);
                        d.amount -= pay;
                        monthlyBudget -= pay;
                        if (monthlyBudget <= 0) break;
                    }
                }
            }
            return { months, interest: totalInterest };
        }

        function openAddDebtPage() {
            document.getElementById('input-debt-name').value = '';
            document.getElementById('input-debt-amount').value = '';
            document.getElementById('input-debt-rate').value = '';
            document.getElementById('input-debt-min-payment').value = ''; 
            navigateToPage('page-add-debt');
        }

        function setDebtType(type, el) {
            el.parentElement.querySelectorAll('.segment-button').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active'); debtTypeMode = type;
        }

        async function saveDebt() {
            const name = document.getElementById('input-debt-name').value;
            const amount = document.getElementById('input-debt-amount').value;
            const rate = document.getElementById('input-debt-rate').value || 0;
            const min_payment = document.getElementById('input-debt-min-payment').value || 0;
            if(!name || !amount) return TelegramWebApp.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Å—É–º–º—É");
            TelegramWebApp.MainButton.showProgress();
            try {
                await callApi('manage_debt', { type: 'add', name, amount, rate, debt_type: debtTypeMode, min_payment });
                navigateToPage('page-debts');
            } catch(e) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞"); }
            TelegramWebApp.MainButton.hideProgress();
        }

        async function deleteDebt(id) {
            TelegramWebApp.showConfirm("–£–¥–∞–ª–∏—Ç—å?", async (ok) => {
                if (ok) {
                    TelegramWebApp.showPopup({
                        title: "–î–µ–π—Å—Ç–≤–∏–µ",
                        message: "–°–ø–∏—Å–∞—Ç—å –¥–æ–ª–≥ –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?",
                        buttons: [{id: 'forgive', type: 'default', text: '–°–ø–∏—Å–∞—Ç—å'}, {id: 'delete', type: 'destructive', text: '–£–¥–∞–ª–∏—Ç—å'}, {type: 'cancel'}]
                    }, async (btnId) => { if(btnId) { await callApi('manage_debt', { type: btnId, id }); loadDebts(); } });
                }
            });
        }

        function openRepayModal(id, name) { currentRepayDebtId = id; document.getElementById('repay-modal-title').innerText = name; document.getElementById('input-repay-amount').value = ''; document.getElementById('repay-modal-overlay').classList.add('visible'); document.getElementById('input-repay-amount').focus(); }
        function closeRepayModal() { document.getElementById('repay-modal-overlay').classList.remove('visible'); currentRepayDebtId = null; }
        
       async function confirmRepayDebt() {
            const amt = document.getElementById('input-repay-amount').value;
            if(!amt || amt <= 0) return TelegramWebApp.showAlert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");
            
            // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º ID, –ø–æ–∫–∞ –æ–Ω –Ω–µ —Å—Ç–µ—Ä—Å—è
            const debtIdToRepay = currentRepayDebtId;

            if (!debtIdToRepay) {
                return TelegramWebApp.showAlert("–û—à–∏–±–∫–∞: –¥–æ–ª–≥ –Ω–µ –≤—ã–±—Ä–∞–Ω");
            }
            
            // 2. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            closeRepayModal(); 
            
            TelegramWebApp.MainButton.showProgress();
            
            try { 
                // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º ID
                await callApi('manage_debt', { type: 'repay', id: debtIdToRepay, amount: amt }); 
                await loadDebts(); 
                TelegramWebApp.HapticFeedback.notificationOccurred('success'); 
            } catch(e) { 
                TelegramWebApp.showAlert("–û—à–∏–±–∫–∞: " + e.message); 
            }
            TelegramWebApp.MainButton.hideProgress();
        }

        /* --- SUBSCRIPTIONS --- */
        function openSubscriptionsPage() { navigateToPage('page-subscriptions'); loadSubscriptions(); }
        async function loadSubscriptions() {
            const container = document.getElementById('subscriptions-list-container');
            container.innerHTML = '<div style="padding:20px;text-align:center;color:#666">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const subs = await callApi('get_subscriptions');
                container.innerHTML = '';
                if (!subs.length) { container.innerHTML = '<div style="padding:20px;text-align:center;color:#666">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</div>'; return; }
                subs.forEach(s => {
                    const row = document.createElement('div'); row.className = 'list-item-row';
                    row.innerHTML = `<div style="display:flex; flex-direction:column;"><span style="font-size:17px; font-weight:500;">${s.name}</span><span style="font-size:13px; color:#8E8E93;">${s.day} —á–∏—Å–ª–æ ‚Ä¢ ${s.category}</span></div><div style="display:flex; align-items:center;"><span style="font-size:17px; font-weight:600; margin-right:15px;">${currencyFormatter(s.amount).replace('‚ÇΩ','')} ‚ÇΩ</span><div class="action-icon-button" onclick="deleteSubscription('${s.id}')" style="color:#FF453A;">√ó</div></div>`;
                    container.appendChild(row);
                });
            } catch(e) { container.innerHTML = '<div style="text-align:center;color:#FF453A">–û—à–∏–±–∫–∞</div>'; }
        }

        function openAddSubscriptionPage() { document.getElementById('input-sub-name').value = ''; document.getElementById('input-sub-amount').value = ''; document.getElementById('input-sub-day').value = ''; selectedCategoryId = null; document.getElementById('display-selected-category-sub').innerText = '–ù–µ –≤—ã–±—Ä–∞–Ω–æ'; document.getElementById('display-selected-category-sub').style.color = '#8E8E93'; navigateToPage('page-add-subscription'); }
        async function saveSubscription() {
            const name = document.getElementById('input-sub-name').value; const amount = document.getElementById('input-sub-amount').value; const day = document.getElementById('input-sub-day').value; const cat = categoriesList.find(c => c.id === selectedCategoryId);
            if (!name || !amount || !day || !cat) return TelegramWebApp.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
            TelegramWebApp.MainButton.showProgress();
            try { await callApi('add_subscription', { name, amount, category: cat.name, day }); openSubscriptionsPage(); } catch(e) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞"); }
            TelegramWebApp.MainButton.hideProgress();
        }
        async function deleteSubscription(id) { TelegramWebApp.showConfirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É?", async (ok) => { if (ok) { await callApi('delete_subscription', { id }); loadSubscriptions(); } }); }

        /* --- SETTINGS --- */
        async function forceUpdateStructure() { TelegramWebApp.showConfirm("–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã?", async (ok) => { if (ok) { TelegramWebApp.MainButton.showProgress(); try { await callApi('update_structure'); TelegramWebApp.showAlert("–ì–æ—Ç–æ–≤–æ!"); } catch (e) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞: " + e.message); } TelegramWebApp.MainButton.hideProgress(); } }); }
        
        function promptSetLimit(id, name, currentLimit) {
            if (currentChartMode !== 'expense') return; 
            currentBudgetCategoryId = id; document.getElementById('budget-modal-title').innerText = name; document.getElementById('input-budget-limit').value = currentLimit > 0 ? currentLimit : '';
            const statsContainer = document.getElementById('budget-stats-container'); statsContainer.innerHTML = '<div style="text-align: center; color: #8E8E93; font-size: 13px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞...</div>';
            document.getElementById('budget-modal-overlay').classList.add('visible'); document.getElementById('input-budget-limit').focus(); loadBudgetStats(name);
        }

        async function loadBudgetStats(categoryName) {
            const container = document.getElementById('budget-stats-container');
            try {
                const data = await callApi('get_category_stats', { category: categoryName });
                if (!data.history || data.history.length === 0) { container.innerHTML = '<div style="text-align: center; color: #8E8E93; font-size: 13px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; return; }
                let html = ''; data.history.forEach(h => { html += `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;"><span style="color:#8E8E93">${h.label}</span><span>${currencyFormatter(h.amount)}</span></div>`; }); container.innerHTML = html;
            } catch (e) { container.innerHTML = 'Error'; }
        }

        function closeBudgetModal() { document.getElementById('budget-modal-overlay').classList.remove('visible'); currentBudgetCategoryId = null; }
        async function saveBudgetFromModal() {
            const val = parseFloat(document.getElementById('input-budget-limit').value); const categoryName = document.getElementById('budget-modal-title').innerText;
            if (isNaN(val) || val < 0) return;
            closeBudgetModal(); TelegramWebApp.MainButton.showProgress();
            try { await callApi('set_budget', { category_name: categoryName, limit: val }); refreshHomePage(); TelegramWebApp.HapticFeedback.notificationOccurred('success'); } catch (e) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞"); }
            TelegramWebApp.MainButton.hideProgress();
        }

        function openEditMode(t) {
            if (!t.id) return; editingTransactionId = t.id;
            document.getElementById('input-transaction-amount').value = Math.abs(t.amount); document.getElementById('input-transaction-comment').value = t.comment;
            try { const parts = t.date.split(' ')[0].split('.'); document.getElementById('input-transaction-date').value = `${parts[2]}-${parts[1]}-${parts[0]}`; } catch(e) { }
            const cat = categoriesList.find(c => c.name === t.category);
            if (cat) { selectedCategoryId = cat.id; document.getElementById('display-selected-category').innerText = cat.name; document.getElementById('display-selected-category').style.color = '#FFFFFF'; }
            document.getElementById('add-page-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"; document.getElementById('edit-mode-indicator').classList.remove('hidden'); document.getElementById('button-cancel-edit').classList.remove('hidden'); navigateToPage('page-add');
        }

        function cancelEditMode() {
            editingTransactionId = null; document.getElementById('input-transaction-amount').value = ''; document.getElementById('input-transaction-comment').value = ''; document.getElementById('display-selected-category').innerText = '–í—ã–±—Ä–∞—Ç—å'; document.getElementById('display-selected-category').style.color = '#8E8E93'; selectedCategoryId = null;
            document.getElementById('add-page-title').innerText = "–ó–∞–ø–∏—Å—å"; document.getElementById('edit-mode-indicator').classList.add('hidden'); document.getElementById('button-cancel-edit').classList.add('hidden');
        }

        async function deleteTransaction(id) { TelegramWebApp.showConfirm("–£–¥–∞–ª–∏—Ç—å?", async (ok) => { if (ok) { await callApi('delete_transaction', { id: id }); refreshHomePage(); } }); }

        function setNewCategoryType(type, el) { el.parentElement.querySelectorAll('.segment-button').forEach(btn => btn.classList.remove('active')); el.classList.add('active'); newCategoryTypeMode = type; }
        
        async function loadCategoriesFromBackend() { categoriesList = await callApi('get_categories'); }

        async function renderSettingsPage() {
            loadFamilyMembers(); 
            
            // Load Settings for Emergency Fund
            try {
                const settings = await callApi('get_settings');
                if(settings.emergency_fund_goal) {
                    document.getElementById('input-settings-emergency').value = settings.emergency_fund_goal;
                }
            } catch(e) {}

            const list = document.getElementById('settings-categories-list'); list.innerHTML = '';
            if (!categoriesList.length) { list.innerHTML = '–ü—É—Å—Ç–æ'; return; }
            [...categoriesList].sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const color = c.type === 'expense' ? '#FF453A' : '#30D158';
                const row = document.createElement('div'); row.className = 'list-item-row';
                row.innerHTML = `<div style="display:flex;align-items:center;"><div class="category-color-dot" style="background:${color}"></div><span style="font-size:17px">${c.name}</span></div><div style="display:flex; align-items:center;"><div class="action-icon-button" onclick="editCategory('${c.id}', '${c.name}')" style="color:#0A84FF; font-size:20px; margin-right:10px;">‚úé</div><div class="action-icon-button" onclick="deleteCategory('${c.id}')" style="color:#FF453A; font-size:22px;">√ó</div></div>`;
                list.appendChild(row);
            });
        }
        
        async function editCategory(id, currentName) {
            const newName = prompt("–ù–æ–≤–æ–µ –∏–º—è:", currentName);
            if (newName && newName !== currentName) {
                TelegramWebApp.MainButton.showProgress();
                try { await callApi('edit_category', { id: id, new_name: newName.trim() }); categoriesList.find(c => c.id === id).name = newName.trim(); renderSettingsPage(); TelegramWebApp.HapticFeedback.notificationOccurred('success'); } catch (e) { TelegramWebApp.showAlert("–û—à–∏–±–∫–∞: " + e.message); }
                TelegramWebApp.MainButton.hideProgress();
            }
        }

        async function loadFamilyMembers() { try { const data = await callApi('get_family_members'); renderFamilyList(data); } catch (e) {} }
        function renderFamilyList(data) {
            const list = document.getElementById('family-list-container'); const title = document.getElementById('family-list-title');
            if (!data.members || data.members.length < 1) { list.classList.add('hidden'); title.classList.add('hidden'); return; }
            list.classList.remove('hidden'); title.classList.remove('hidden'); list.innerHTML = '';
            data.members.forEach(m => {
                const isMe = (m.id == myTelegramId); let badges = ''; if (m.is_owner) badges += '<span class="owner-badge">–í–ª–∞–¥–µ–ª–µ—Ü</span>'; if (isMe) badges += '<span class="me-badge">(–í—ã)</span>';
                let deleteBtn = ''; if (data.is_requester_owner && !isMe) deleteBtn = `<div class="action-icon-button" onclick="kickMember('${m.id}', '${m.name}')" style="color:#FF453A; padding-left:15px;">‚úï</div>`;
                const row = document.createElement('div'); row.className = 'list-item-row';
                row.innerHTML = `<div style="display:flex; align-items:center; overflow:hidden;"><div class="avatar-circle">${m.name.charAt(0).toUpperCase()}</div><div style="display:flex; flex-direction:column;"><span style="font-size:17px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.name}</span></div>${badges}</div>${deleteBtn}`;
                list.appendChild(row);
            });
        }
        function kickMember(id, name) { TelegramWebApp.showConfirm(`–ò—Å–∫–ª—é—á–∏—Ç—å ${name}?`, async (ok) => { if (ok) { try { await callApi('kick_member', { id: id }); loadFamilyMembers(); } catch (e) {} } }); }

        document.getElementById('button-create-category').onclick = async () => {
            const name = document.getElementById('input-new-category-name').value.trim();
            if (!name) return TelegramWebApp.showAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏");
            await callApi('add_category', { name: name, type: newCategoryTypeMode });
            document.getElementById('input-new-category-name').value = ''; await loadCategoriesFromBackend(); renderSettingsPage(); TelegramWebApp.HapticFeedback.notificationOccurred('success');
        };

        async function deleteCategory(id) { TelegramWebApp.showConfirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?", async (ok) => { if (ok) { await callApi('delete_category', { id: id }); categoriesList = categoriesList.filter(c => c.id !== id); renderSettingsPage(); } }); }

        function inviteFamilyMember() {
            if (!myTelegramId) return TelegramWebApp.showAlert("–û—à–∏–±–∫–∞ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
            const inviteUrl = `https://t.me/share/url?url=https://t.me/${BOT_USERNAME}?start=join_${myTelegramId}&text=–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –º–æ–µ–º—É —Å–µ–º–µ–π–Ω–æ–º—É –±—é–¥–∂–µ—Ç—É!`;
            TelegramWebApp.openTelegramLink(inviteUrl);
        }

        // --- GLOBAL MODAL CONTROLLER ---
        const modalOverlay = document.getElementById('modal-overlay');
        const modalList = document.getElementById('modal-list-container');
        const modalTitle = document.getElementById('modal-header-title');
        
        function openCategorySelectionModal() {
            modalTitle.innerText = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è"; modalList.innerHTML = '';
            let typeToFilter = transactionType;
            if (document.getElementById('page-add-subscription').classList.contains('active')) { typeToFilter = 'expense'; }
            const filteredCats = categoriesList.filter(c => c.type === typeToFilter);
            if (filteredCats.length === 0) { modalList.innerHTML = '<div style="padding:20px;text-align:center;color:#8E8E93">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π —ç—Ç–æ–≥–æ —Ç–∏–ø–∞</div>'; }
            [...filteredCats].sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const color = c.type === 'expense' ? '#FF453A' : '#30D158'; const row = document.createElement('div'); row.className = 'list-item-row'; row.style.cursor = 'pointer';
                const isSubMode = document.getElementById('page-add-subscription').classList.contains('active');
                row.onclick = () => { 
                    selectedCategoryId = c.id; 
                    if (isSubMode) { document.getElementById('display-selected-category-sub').innerText = c.name; document.getElementById('display-selected-category-sub').style.color = '#FFFFFF'; } 
                    else { document.getElementById('display-selected-category').innerText = c.name; document.getElementById('display-selected-category').style.color = '#FFFFFF'; }
                    modalOverlay.classList.remove('visible'); 
                };
                row.innerHTML = `<div style="display:flex;align-items:center;"><div class="category-color-dot" style="background:${color}"></div><span style="font-size:17px">${c.name}</span></div>${selectedCategoryId === c.id ? '<span style="color:#0A84FF">‚úì</span>' : ''}`;
                modalList.appendChild(row);
            });
            modalOverlay.classList.add('visible');
        }

        function openWalletSelectionModal(mode) {
            walletSelectionMode = mode; modalTitle.innerText = mode === 'from' ? "–°—á–µ—Ç —Å–ø–∏—Å–∞–Ω–∏—è" : "–ö—É–¥–∞ –∑–∞—á–∏—Å–ª–∏—Ç—å"; modalList.innerHTML = '';
            if (walletsList.length === 0) { callApi('get_wallets').then(d => { walletsList = d.wallets; renderWalletModalItems(); }); } else { renderWalletModalItems(); }
            modalOverlay.classList.add('visible');
        }

        function renderWalletModalItems() {
            modalList.innerHTML = '';
            walletsList.forEach(w => {
                const row = document.createElement('div'); row.className = 'list-item-row'; row.style.cursor = 'pointer';
                row.onclick = () => { 
                    if (walletSelectionMode === 'from') { selectedWalletId = w.uuid; const display = document.getElementById('display-selected-wallet'); display.innerText = "üí≥ " + w.name; display.style.color = '#FFFFFF'; } 
                    else { selectedWalletToId = w.uuid; const display = document.getElementById('display-wallet-to'); display.innerText = "üí≥ " + w.name; display.style.color = '#FFFFFF'; }
                    modalOverlay.classList.remove('visible'); 
                };
                row.innerHTML = `<div style="display:flex; flex-direction:column;"><span style="font-size:17px; font-weight:500;">${w.name} ${w.is_default?'<span style="color:var(--accent-yellow)">‚òÖ</span>':''}</span></div><span style="color:#888; font-size:15px;">${currencyFormatter(w.balance)}</span>`;
                modalList.appendChild(row);
            });
        }

        modalOverlay.onclick = (e) => { if (e.target === modalOverlay) modalOverlay.classList.remove('visible'); }

        TelegramWebApp.MainButton.onClick(async () => {
            const amt = document.getElementById('input-transaction-amount').value; const cmt = document.getElementById('input-transaction-comment').value; const dateVal = document.getElementById('input-transaction-date').value; 
            if (!amt) return TelegramWebApp.showAlert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"); if (!dateVal) return TelegramWebApp.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É");
            TelegramWebApp.MainButton.showProgress();
            try {
                if (transactionType === 'transfer') {
                    if (!selectedWalletId || !selectedWalletToId) { TelegramWebApp.MainButton.hideProgress(); return TelegramWebApp.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–∞ —Å—á–µ—Ç–∞"); }
                    if (selectedWalletId === selectedWalletToId) { TelegramWebApp.MainButton.hideProgress(); return TelegramWebApp.showAlert("–°—á–µ—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏"); }
                    await callApi('transfer_between_wallets', { from_wallet: selectedWalletId, to_wallet: selectedWalletToId, amount: amt, date: dateVal, comment: cmt });
                    TelegramWebApp.HapticFeedback.notificationOccurred('success'); document.getElementById('input-transaction-amount').value = ''; document.getElementById('input-transaction-comment').value = ''; navigateToPage('page-home');
                } else {
                    const cat = categoriesList.find(c => c.id === selectedCategoryId);
                    if (!cat) { TelegramWebApp.MainButton.hideProgress(); return TelegramWebApp.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"); }
                    if (editingTransactionId) { await callApi('edit_transaction', { id: editingTransactionId, amount: amt, category: cat.name, type: transactionType, comment: cmt, date: dateVal, wallet_uuid: selectedWalletId }); TelegramWebApp.HapticFeedback.notificationOccurred('success'); cancelEditMode(); navigateToPage('page-home'); } 
                    else { await callApi('add_transaction', { amount: amt, category: cat.name, type: transactionType, comment: cmt, date: dateVal, wallet_uuid: selectedWalletId }); TelegramWebApp.HapticFeedback.notificationOccurred('success'); document.getElementById('input-transaction-amount').value = ''; document.getElementById('input-transaction-comment').value = ''; navigateToPage('page-home'); }
                }
            } catch (error) { console.error(error); }
            TelegramWebApp.MainButton.hideProgress();
        });

        async function startApp() {
            TelegramWebApp.ready(); TelegramWebApp.expand(); TelegramWebApp.setHeaderColor('#000000'); TelegramWebApp.setBackgroundColor('#000000');
            try {
                const check = await callApi('check_user'); document.getElementById('loading-screen').classList.add('hidden');
                if (check.is_registered) { myTelegramId = check.user_id; document.getElementById('app-container').classList.remove('hidden'); categoriesList = await callApi('get_categories'); const wData = await callApi('get_wallets'); walletsList = wData.wallets; refreshHomePage(); } 
                else { document.getElementById('authorization-screen').classList.remove('hidden'); }
            } catch (error) { console.error("Init:", error); }
        }
        startApp();
    </script>
</body>
</html>